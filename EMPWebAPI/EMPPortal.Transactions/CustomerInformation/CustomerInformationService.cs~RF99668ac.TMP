using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using EMPEntityFramework.Edmx;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using EMP.Core.Utilities;
using EMPPortal.Transactions.CustomerInformation.DTO;
using EMPPortal.Transactions.EnrollmentBankSelectionInfo;
using MoreLinq;
using EMPPortal.Core.Utilities;
using EMPPortal.Transactions.CrosslinkService;
using EMPPortal.Transactions.DropDowns;

namespace EMPPortal.Transactions.CustomerInformation
{
    public class CustomerInformationService
    {
        private DatabaseEntities db = new DatabaseEntities();
        CrosslinkWS17SoapClient _apiObj = new CrosslinkWS17SoapClient();

        // GET: api/emp_CustomerInformation
        public async Task<List<CustomerInformationModel>> GetAllCustomerInformation()
        {
            try
            {

                //Guid entityid;
                //  bool IsExist = Guid.TryParse("8f4fca72-3d3c-4ad3-8f1c-1de3d602fd73", out entityid);

                int EntityId = (int)EMPConstants.Entity.uTax;


                var emp = await db.emp_CustomerInformation.Where(o => o.StatusCode == EMPConstants.NewCustomer && o.EntityId != EntityId).Select(e => new CustomerInformationModel
                {
                    Id = e.Id,
                    CompanyName = e.CompanyName != null ? e.CompanyName.ToString() : "",
                    AccountStatus = e.AccountStatus != null ? e.AccountStatus.ToString() : "",
                    Feeder = e.Feeder,
                    BusinessOwnerFirstName = e.BusinessOwnerFirstName != null ? e.BusinessOwnerFirstName.ToString() : "",
                    OfficePhone = e.OfficePhone != null ? e.OfficePhone.ToString() : "",
                    AlternatePhone = e.AlternatePhone != null ? e.AlternatePhone.ToString() : "",
                    Primaryemail = e.PrimaryEmail != null ? e.PrimaryEmail.ToString() : "",
                    SupportNotificationemail = e.SupportNotificationEmail != null ? e.SupportNotificationEmail.ToString() : "",
                    EROType = e.EROType != null ? e.EROType.ToString() : "",
                    AlternativeContact = e.AlternativeContact != null ? e.AlternativeContact.ToString() : "",
                    EFIN = e.EFIN,
                    PhysicalAddress1 = e.PhysicalAddress1 != null ? e.PhysicalAddress1.ToString() : "",
                    PhysicalAddress2 = e.PhysicalAddress2 != null ? e.PhysicalAddress2.ToString() : "",
                    PhysicalZipcode = e.PhysicalZipCode != null ? e.PhysicalZipCode.ToString() : "",
                    PhysicalCity = e.PhysicalCity != null ? e.PhysicalCity.ToString() : "",
                    PhysicalState = e.PhysicalState != null ? e.PhysicalState.ToString() : "",
                    ShippingAddress1 = e.ShippingAddress1 != null ? e.ShippingAddress1.ToString() : "",
                    ShippingAddress2 = e.ShippingAddress2 != null ? e.ShippingAddress2.ToString() : "",
                    ShippingZipcode = e.ShippingZipCode != null ? e.ShippingZipCode.ToString() : "",
                    ShippingCity = e.ShippingCity != null ? e.ShippingCity.ToString() : "",
                    ShippingState = e.ShippingState != null ? e.ShippingState.ToString() : "",
                    PhoneTypeId = e.PhoneTypeId,
                    ParentId = e.ParentId,
                    TitleId = e.TitleId,
                    AlternativeType = e.AlternativeType,
                    PhoneType = db.PhoneTypeMasters.Where(a => a.Id == e.PhoneTypeId).Select(a => a.PhoneType != null ? a.PhoneType.ToString() : "").FirstOrDefault(),
                    ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == e.TitleId).Select(a => a.ContactPersonTitle != null ? a.ContactPersonTitle.ToString() : "").FirstOrDefault(),
                    EntityId = e.EntityId ?? 0,
                    SalesYearID = e.SalesYearID ?? Guid.Empty,
                    SalesforceParentID = e.SalesforceParentID != null ? e.SalesforceParentID.ToString() : "",
                    MasterIdentifier = e.MasterIdentifier != null ? e.MasterIdentifier.ToString() : "",
                    IsVerified = e.IsVerified ?? false,
                    IsMSOUser = e.IsMSOUser ?? false,
                    IsActivationCompleted = e.IsActivationCompleted ?? 0,
                    StatusCode = e.StatusCode.ToString(),

                }).Distinct().ToListAsync();

                return emp;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetAllCustomerInformation", Guid.Empty);
                return null;
            }

        }

        public IQueryable<CustomerModel> CustomerSearchInfoLazyLoad(Guid UserName, string Status, string SiteType, string BankPartner, string EnrollmentStatus, string OnBoardingStatus, string SearchText, int SearchType, int count)
        {
            try
            {

                List<string> Statuslst = !string.IsNullOrEmpty(Status) ? Status.Split(',').ToList() : null;
                List<string> SiteTypelst = !string.IsNullOrEmpty(SiteType) ? SiteType.Split(',').ToList() : null;
                List<string> BankPartnerlst = !string.IsNullOrEmpty(BankPartner) ? BankPartner.Split(',').ToList() : null;
                List<string> EnrollmentStatuslst = !string.IsNullOrEmpty(EnrollmentStatus) ? EnrollmentStatus.Split(',').ToList() : null;
                List<string> OnBoardingStatuslst = !string.IsNullOrEmpty(OnBoardingStatus) ? OnBoardingStatus.Split(',').ToList() : null;

                var data1 = (from e in db.emp_CustomerInformation
                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                             where e.ParentId == null && cli.CrossLinkUserId != null //&& e.AlternativeContact != null && e.AlternatePhone != null
                             && e.StatusCode != EMPConstants.NewCustomer
                             select new { e, cli }).ToList();

                var data = data1.Skip(count).Take(15).ToList();


                if (data.Count > 0)
                {
                    if (data.Any(a => a.cli.CustomerOfficeId == UserName))
                    {
                        data = data.Where(a => a.cli.CustomerOfficeId == UserName).ToList();
                    }
                }
                List<CustomerModel> customerlst = new List<CustomerModel>();
                foreach (var itm in data)
                {
                    CustomerModel ocustomer = new CustomerModel();
                    ocustomer.Id = itm.e.Id;
                    ocustomer.ParentId = itm.e.ParentId ?? Guid.Empty;
                    ocustomer.CompanyName = itm.e.CompanyName;
                    ocustomer.AccountStatus = itm.e.AccountStatus;
                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    ocustomer.MasterIdentifier = itm.e.MasterIdentifier;
                    ocustomer.Feeder = itm.e.Feeder;
                    ocustomer.BusinessOwnerFirstName = itm.e.BusinessOwnerFirstName;
                    ocustomer.OfficePhone = itm.e.OfficePhone;
                    ocustomer.AlternatePhone = itm.e.AlternatePhone;
                    ocustomer.Primaryemail = itm.e.PrimaryEmail;
                    ocustomer.SupportNotificationemail = itm.e.SupportNotificationEmail;
                    ocustomer.EROType = itm.e.EROType;
                    ocustomer.AlternativeContact = itm.e.AlternativeContact ?? "";
                    ocustomer.EFIN = itm.e.EFIN;
                    ocustomer.PhysicalAddress1 = itm.e.PhysicalAddress1;
                    ocustomer.PhysicalAddress2 = itm.e.PhysicalAddress2;
                    ocustomer.PhysicalZipcode = itm.e.PhysicalZipCode;
                    ocustomer.PhysicalCity = itm.e.PhysicalCity;
                    ocustomer.PhysicalState = itm.e.PhysicalState;
                    ocustomer.ShippingAddress1 = itm.e.ShippingAddress1;
                    ocustomer.ShippingAddress2 = itm.e.ShippingAddress2;
                    ocustomer.ShippingZipcode = itm.e.ShippingZipCode;
                    ocustomer.ShippingCity = itm.e.ShippingCity;
                    ocustomer.ShippingState = itm.e.ShippingState;
                    ocustomer.PhoneTypeId = itm.e.PhoneTypeId;
                    ocustomer.TitleId = itm.e.TitleId;
                    ocustomer.AlternativeType = itm.e.AlternativeType;
                    ocustomer.PhoneType = db.PhoneTypeMasters.Where(a => a.Id == itm.e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault();
                    ocustomer.ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == itm.e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault() ?? "";
                    ocustomer.EntityId = itm.e.EntityId ?? 0;
                    ocustomer.SalesYearID = itm.e.SalesYearID ?? Guid.Empty;
                    ocustomer.BaseEntityId = db.EntityMasters.Where(a => a.Id == itm.e.EntityId).Select(a => a.BaseEntityId).FirstOrDefault();
                    ocustomer.LoginId = itm.cli.Id.ToString();
                    ocustomer.LoginEFIN = itm.cli.EFIN;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.CrossLinkUserId = itm.cli.CrossLinkUserId ?? "";
                    ocustomer.CrossLinkPassword = itm.cli.CrossLinkPassword;
                    ocustomer.OfficePortalUrl = itm.cli.OfficePortalUrl;
                    ocustomer.TaxOfficeUsername = itm.cli.TaxOfficeUsername;
                    ocustomer.TaxOfficePassword = itm.cli.TaxOfficePassword;
                    ocustomer.CustomerOfficeId = itm.cli.CustomerOfficeId;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.IsActivationCompleted = itm.e.IsActivationCompleted ?? 0;

                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    if (itm.e.IsActivationCompleted == null || itm.e.IsActivationCompleted == 0)
                        ocustomer.ActivationStatus = "Not Active";
                    else
                        ocustomer.ActivationStatus = "Active";

                    ocustomer.CreatedDate = itm.cli.CreatedDate ?? Convert.ToDateTime("01/01/2000");
                    ocustomer.LastUpdatedDate = itm.e.LastUpdatedDate ?? Convert.ToDateTime("01/01/2000");

                    EnrollmentBankSelectionService serv = new EnrollmentBankSelectionInfo.EnrollmentBankSelectionService();
                    var enrdata = serv.getEnrollmentStatusInfo(ocustomer.Id);
                    ocustomer.ActiveBank = enrdata.BankName;
                    ocustomer.SubmissionDate = enrdata.SubmitedDate;
                    ocustomer.EnrollmentStatus = enrdata.SubmissionStaus;
                    ocustomer.ApprovedBank = enrdata.ApprovedBank;
                    ocustomer.RejectedBanks = enrdata.RejectedBanks;

                    //var CustFees = CustomerFees(itm.e.Id);
                    //foreach (var fees in CustFees)
                    //{
                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                    //    {
                    //        ocustomer.TotalServiceFee = fees.Amount;
                    //        ocustomer.ServiceTooltip = fees.FeesName;
                    //    }

                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                    //    {
                    //        ocustomer.TotalTransFee = fees.Amount;
                    //        ocustomer.TransTooltip = fees.FeesName;
                    //    }
                    //}

                    //var BankFees = BankFee(itm.e.Id, itm.e.Id, ocustomer.CompanyName, ocustomer.CompanyName, 0);
                    //foreach (var fees in BankFees)
                    //{
                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                    //    {
                    //        ocustomer.TotalServiceFee = ocustomer.TotalServiceFee + fees.Amount;
                    //        ocustomer.ServiceTooltip = ocustomer.ServiceTooltip + fees.FeesName;
                    //    }

                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                    //    {
                    //        ocustomer.TotalTransFee = ocustomer.TotalTransFee + fees.Amount;
                    //        ocustomer.TransTooltip = ocustomer.TransTooltip + fees.FeesName;
                    //    }
                    //}
                    //if (SearchType > 0)
                    //{
                    var ChildDataLst = GetChildCustomerInfo(itm.e.Id, itm.e.CompanyName, Statuslst, SiteTypelst, SearchText, SearchType, UserName);
                    ocustomer.ChaildCustomerInfo = ChildDataLst;
                    //}
                    //else
                    //{
                    //    var ChildDataLst = GetChildCustomerInfo(itm.e.Id, "", Statuslst., SiteTypelst.DefaultIfEmpty, "", 0, Guid.Empty);
                    //    ocustomer.ChaildCustomerInfo = ChildDataLst;
                    //}

                    if (ocustomer.EROType == "Single Office")
                        ocustomer.IsActivated = true;
                    else
                    {
                        ocustomer.IsActivated = itm.e.IsActivationCompleted.HasValue ? (itm.e.IsActivationCompleted.Value == 1 ? true : false) : false;
                    }

                    customerlst.Add(ocustomer);
                }

                if (Statuslst != null)
                {
                    customerlst = customerlst.Where(o => Statuslst.Contains(o.StatusCode) || o.ChaildCustomerInfo.Count > 0).ToList();
                }
                if (SiteTypelst != null)
                {
                    customerlst = customerlst.Where(o => SiteTypelst.Contains(o.EntityId.ToString()) || o.ChaildCustomerInfo.Count > 0).ToList();
                }

                if (SearchType > 0)
                {
                    if (SearchType == 1)
                    {
                        customerlst = customerlst.Where(o => o.CompanyName.ToString().ToLower().Contains(SearchText.ToLower()) || o.ChaildCustomerInfo.Count > 0).ToList();
                    }
                    else if (SearchType == 2)
                    {
                        customerlst = customerlst.Where(o => o.CrossLinkUserId.ToString().ToLower().Contains(SearchText.ToLower()) || o.ChaildCustomerInfo.Count > 0).ToList();
                    }
                    else if (SearchType == 3)
                    {
                        customerlst = customerlst.Where(o => o.EFIN.ToString().ToLower().Contains(SearchText.ToLower()) || o.ChaildCustomerInfo.Count > 0).ToList();
                    }
                    else if (SearchType == 4)
                    {
                        customerlst = customerlst.Where(o => o.AlternativeContact != null ? o.AlternativeContact.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternativeContact == o.AlternativeContact).ToList();
                    }
                    else if (SearchType == 5)
                    {
                        customerlst = customerlst.Where(o => o.AlternatePhone != null ? o.AlternatePhone.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternatePhone == o.AlternatePhone).ToList();
                    }
                }
                return customerlst.OrderBy(a => a.CompanyName).AsQueryable();

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/CustomerSearchInfoLazyLoad", UserName);
                return new List<CustomerModel>().AsQueryable();
            }
        }

        // GET: api/emp_CustomerInformation/5
        public async Task<CustomerInformationModel> GetCustomerInformation(Guid id)
        {
            try
            {

                var customerInformation = await db.emp_CustomerInformation.Where(e => e.Id == id).Select(e => new CustomerInformationModel
                {
                    Id = e.Id,
                    CompanyName = e.CompanyName != null ? e.CompanyName.ToString() : "",
                    AccountStatus = e.AccountStatus != null ? e.AccountStatus.ToString() : "",
                    Feeder = e.Feeder,
                    BusinessOwnerFirstName = e.BusinessOwnerFirstName != null ? e.BusinessOwnerFirstName.ToString() : "",
                    OfficePhone = e.OfficePhone != null ? e.OfficePhone.ToString() : "",
                    AlternatePhone = e.AlternatePhone != null ? e.AlternatePhone.ToString() : "",
                    Primaryemail = e.PrimaryEmail != null ? e.PrimaryEmail.ToString() : "",
                    SupportNotificationemail = e.SupportNotificationEmail != null ? e.SupportNotificationEmail.ToString() : "",
                    EROType = e.EROType != null ? e.EROType.ToString() : "",
                    AlternativeContact = e.AlternativeContact != null ? e.AlternativeContact.ToString() : "",
                    EFIN = e.EFIN,
                    PhysicalAddress1 = e.PhysicalAddress1 != null ? e.PhysicalAddress1.ToString() : "",
                    PhysicalAddress2 = e.PhysicalAddress2 != null ? e.PhysicalAddress2.ToString() : "",
                    PhysicalZipcode = e.PhysicalZipCode != null ? e.PhysicalZipCode.ToString() : "",
                    PhysicalCity = e.PhysicalCity != null ? e.PhysicalCity.ToString() : "",
                    PhysicalState = e.PhysicalState != null ? e.PhysicalState.ToString() : "",
                    ShippingAddress1 = e.ShippingAddress1 != null ? e.ShippingAddress1.ToString() : "",
                    ShippingAddress2 = e.ShippingAddress2 != null ? e.ShippingAddress2.ToString() : "",
                    ShippingZipcode = e.ShippingZipCode != null ? e.ShippingZipCode.ToString() : "",
                    ShippingCity = e.ShippingCity != null ? e.ShippingCity.ToString() : "",
                    ShippingState = e.ShippingState != null ? e.ShippingState.ToString() : "",
                    PhoneTypeId = e.PhoneTypeId,
                    ParentId = e.ParentId,
                    TitleId = e.TitleId,
                    AlternativeType = e.AlternativeType,
                    PhoneType = db.PhoneTypeMasters.Where(a => a.Id == e.PhoneTypeId).Select(a => a.PhoneType != null ? a.PhoneType.ToString() : "").FirstOrDefault(),
                    ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == e.TitleId).Select(a => a.ContactPersonTitle != null ? a.ContactPersonTitle.ToString() : "").FirstOrDefault(),
                    EntityId = e.EntityId ?? 0,
                    SalesYearID = e.SalesYearID ?? Guid.Empty,
                    SalesforceParentID = e.SalesforceParentID != null ? e.SalesforceParentID.ToString() : "",
                    MasterIdentifier = e.MasterIdentifier != null ? e.MasterIdentifier.ToString() : "",
                    IsVerified = e.IsVerified ?? false,
                    IsMSOUser = e.IsMSOUser ?? false,
                    IsActivationCompleted = e.IsActivationCompleted ?? 0,
                    StatusCode = e.StatusCode.ToString(),
                    IsNotCollectingFee = e.uTaxNotCollectingSBFee ?? false,
                    BaseEntityId = e.EntityMaster.BaseEntityId ?? 0

                }).Distinct().FirstOrDefaultAsync();

                if (customerInformation != null)
                {
                    customerInformation.IsEnrollmentSubmit = IsEnrollmentSubmit(id);
                }

                return customerInformation;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetCustomerInformation", id);
                return null;
            }
        }

        public bool IsEnrollmentSubmit(Guid Id)
        {
            try
            {

                var BankEnroll = db.BankEnrollments.Any(a => a.CustomerId == Id && a.IsActive == true);
                if (BankEnroll)
                {
                    return true;
                }
                else
                {
                    var custominfo = db.emp_CustomerInformation.Where(a => a.ParentId == Id);
                    if (custominfo != null)
                    {
                        foreach (var cu in custominfo)
                        {
                            var BankEnrolls = db.BankEnrollments.Any(a => a.CustomerId == cu.Id && a.IsActive == true);
                            if (BankEnrolls)
                            {
                                return true;
                            }
                        }
                    }
                }
                return false;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/IsEnrollmentSubmit", Id);
                return false;
            }
        }
        // GET: api/emp_CustomerInformation/5
        public CustomerInformationDisplayDTO Save(CustomerInformationModel model, Guid id)
        {
            try
            {
                int ParentEntityId = 0;
                CustomerInformationDisplayDTO CustomerInfoDisplayDTO = new CustomerInformationDisplayDTO();
                int BaseEntityId = 0;
                int EntityTypeC = 0;
                bool IsAdditionalEFINSubSite = false;
                Guid Customer_GUID;
                if (model != null)
                {
                    var custExist = db.emp_CustomerLoginInformation.Any(a => a.EFIN == model.EFIN && a.CustomerOfficeId != id);
                    if (custExist)
                    {
                        CustomerInfoDisplayDTO.StatusCode = "-1";
                        return CustomerInfoDisplayDTO;
                    }

                    emp_CustomerInformation customerInformation = db.emp_CustomerInformation.Where(e => e.Id == id).FirstOrDefault();
                    if (customerInformation != null)
                    {
                        EntityTypeC = (int)System.Data.Entity.EntityState.Modified;
                    }
                    else
                    {
                        customerInformation = new emp_CustomerInformation();
                        customerInformation.Id = Guid.NewGuid();
                        Customer_GUID = customerInformation.Id;
                    }
                    if (customerInformation.IsActivationCompleted != 1)
                    {
                        //customerInformation.IsActivationCompleted = 0;                        
                        customerInformation.AccountStatus = "Not Active";
                    }

                    if (model.ParentId != null && model.ParentId != Guid.Empty)
                    {

                        customerInformation.ParentId = model.ParentId;

                        var dbParent = (from cu in db.emp_CustomerInformation
                                        join ci in db.emp_CustomerLoginInformation on cu.Id equals ci.CustomerOfficeId
                                        where cu.Id == model.ParentId
                                        select new { cu, ci }).FirstOrDefault();

                        customerInformation.SalesforceParentID = dbParent.ci.CrossLinkUserId;
                        customerInformation.MasterIdentifier = dbParent.ci.MasterIdentifier;

                        // var EntityMaster = db.EntityMasters.Where(a => a.Id == dbParent.cu.EntityId).Select(o => new { o.Name, o.Id,o.BaseEntityId }).FirstOrDefault();

                        if (model.IsAdditionalEFINSubSite == true)
                        {
                            //Entity = (from e in db.EntityMasters
                            //          where e.DisplayId == (int)EMPConstants.Entities.SOME_SubSite
                            //          select new { e.DisplayId, e.Id, e.Name }).FirstOrDefault();

                            IsAdditionalEFINSubSite = true;

                            if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SVB)
                            {
                                customerInformation.EROType = "Service Bureau - Additional EFIN";
                                customerInformation.EntityId = (int)EMPConstants.Entity.SVB_SS_SOME;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                            }
                            if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SVB_SS)
                            {
                                customerInformation.EROType = "Service Bureau - Sub Site - Additional EFIN";
                                customerInformation.EntityId = (int)EMPConstants.Entity.SVB_SS_SOME;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                            }
                            else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SVB_MO)
                            {
                                customerInformation.EROType = "Service Bureau - Multi-Office - Sub Site";
                                customerInformation.EntityId = (int)EMPConstants.Entity.SVB_MO_SS;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                            }
                            else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SVB_MO_SS)
                            {
                                customerInformation.EROType = "Service Bureau - Multi Office - Additional EFIN";
                                customerInformation.EntityId = (int)EMPConstants.Entity.SVB_MO_SS_SOME;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                            }
                            else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.MO_SS)
                            {
                                customerInformation.EROType = "Multi Office - Sub Site";
                                customerInformation.EntityId = (int)EMPConstants.Entity.MO_SS_SOME;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                            }
                            else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.MO)
                            {
                                customerInformation.EROType = "Multi Office - Additional EFIN";
                                customerInformation.EntityId = (int)EMPConstants.Entity.MO_SS_SOME;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                            }
                            else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SO)
                            {
                                customerInformation.EROType = "Single Office - Additional EFIN";
                                customerInformation.EntityId = (int)EMPConstants.Entity.SO_SOME;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                BaseEntityId = (int)EMPConstants.BaseEntities.SOME;
                                ParentEntityId = (int)EMPConstants.Entity.SO;
                            }

                            // EntityDisplayId = (int)EMPConstants.Entities.SOME_SubSite;

                            customerInformation.IsActivationCompleted = 1;
                            customerInformation.IsVerified = true;
                            // customerInformation.AccountStatus = "Active";
                        }
                        else
                        {
                            if (model.IsAdditionalEFINSubSite != true)
                            {
                                if (dbParent.cu.EntityId == (int)EMPConstants.Entity.MO)
                                {
                                    customerInformation.EROType = "Multi Office - Sub Site";
                                    customerInformation.EntityId = (int)EMPConstants.Entity.MO_SS;// new Guid("d4240d22-c1e5-41c0-b34c-a711522f6046");
                                    BaseEntityId = (int)EMPConstants.BaseEntities.SS;
                                }
                                else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SVB)
                                {
                                    customerInformation.EROType = "Service Bureau - Sub Site";
                                    customerInformation.EntityId = (int)EMPConstants.Entity.SVB_SS;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                    BaseEntityId = (int)EMPConstants.BaseEntities.SS;
                                }
                                else if (dbParent.cu.EntityId == (int)EMPConstants.Entity.SVB_MO)
                                {
                                    customerInformation.EROType = "Service Bureau - Multi Office - Sub Site";
                                    customerInformation.EntityId = (int)EMPConstants.Entity.SVB_MO_SS;// new Guid("d894953e-88d3-4edd-9185-a2c07a76da56");
                                    BaseEntityId = (int)EMPConstants.BaseEntities.SS;
                                }
                                else
                                {
                                    return CustomerInfoDisplayDTO;
                                }
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(model.CompanyName))
                        customerInformation.CompanyName = model.CompanyName;


                    if (model.Feeder != null)
                        customerInformation.Feeder = model.Feeder;

                    if (!string.IsNullOrEmpty(model.BusinessOwnerFirstName))
                        customerInformation.BusinessOwnerFirstName = model.BusinessOwnerFirstName;

                    if (!string.IsNullOrEmpty(model.OfficePhone))
                        customerInformation.OfficePhone = model.OfficePhone;

                    if (!string.IsNullOrEmpty(model.AlternatePhone))
                        customerInformation.AlternatePhone = model.AlternatePhone;

                    if (!string.IsNullOrEmpty(model.Primaryemail))
                        customerInformation.PrimaryEmail = model.Primaryemail;

                    if (!string.IsNullOrEmpty(model.SupportNotificationemail))
                        customerInformation.SupportNotificationEmail = model.SupportNotificationemail;

                    if (!string.IsNullOrEmpty(model.EROType))
                        customerInformation.EROType = model.EROType;

                    if (!string.IsNullOrEmpty(model.AlternativeContact))
                        customerInformation.AlternativeContact = model.AlternativeContact;

                    if (model.EFIN != null)
                        customerInformation.EFIN = model.EFIN;

                    if (!string.IsNullOrEmpty(model.PhysicalAddress1))
                        customerInformation.PhysicalAddress1 = model.PhysicalAddress1;

                    if (!string.IsNullOrEmpty(model.PhysicalAddress2))
                        customerInformation.PhysicalAddress2 = model.PhysicalAddress2;

                    if (!string.IsNullOrEmpty(model.PhysicalZipcode))
                        customerInformation.PhysicalZipCode = model.PhysicalZipcode;

                    if (!string.IsNullOrEmpty(model.PhysicalCity))
                        customerInformation.PhysicalCity = model.PhysicalCity;

                    if (!string.IsNullOrEmpty(model.PhysicalState))
                        customerInformation.PhysicalState = model.PhysicalState;

                    if (!string.IsNullOrEmpty(model.ShippingAddress1))
                        customerInformation.ShippingAddress1 = model.ShippingAddress1;

                    if (!string.IsNullOrEmpty(model.ShippingAddress2))
                        customerInformation.ShippingAddress2 = model.ShippingAddress2;

                    if (!string.IsNullOrEmpty(model.ShippingZipcode))
                        customerInformation.ShippingZipCode = model.ShippingZipcode;

                    if (!string.IsNullOrEmpty(model.ShippingCity))
                        customerInformation.ShippingCity = model.ShippingCity;

                    if (!string.IsNullOrEmpty(model.ShippingState))
                        customerInformation.ShippingState = model.ShippingState;

                    if (model.PhoneTypeId != Guid.Empty)
                        customerInformation.PhoneTypeId = model.PhoneTypeId;

                    if (model.TitleId != Guid.Empty)
                        customerInformation.TitleId = model.TitleId;

                    if (model.AlternativeType != Guid.Empty)
                        customerInformation.AlternativeType = model.AlternativeType;


                    //if (!string.IsNullOrEmpty(model.SalesforceParentID))
                    //    customerInformation.SalesforceParentID = model.SalesforceParentID;

                    //if (!string.IsNullOrEmpty(model.MasterIdentifier))
                    //    customerInformation.MasterIdentifier = model.MasterIdentifier;

                    customerInformation.LastUpdatedDate = DateTime.Now;
                    customerInformation.LastUpdatedBy = model.UserId;

                    if (model.UserId == customerInformation.Id || IsAdditionalEFINSubSite)
                        customerInformation.IsVerified = true;

                    if (EntityTypeC == (int)System.Data.Entity.EntityState.Modified)
                    {
                        if (customerInformation.StatusCode != EMPConstants.InProgress && customerInformation.StatusCode != EMPConstants.Active)
                        {
                            customerInformation.StatusCode = EMPConstants.Created;
                        }

                        db.Entry(customerInformation).State = System.Data.Entity.EntityState.Modified;
                    }
                    else
                    {
                        var SalesYear = db.SalesYearMasters.Where(o => o.ApplicableToDate == null).FirstOrDefault();
                        if (SalesYear != null)
                        {
                            customerInformation.SalesYearID = SalesYear.Id;
                            customerInformation.SalesYearGroupId = customerInformation.Id;
                        }

                        customerInformation.StatusCode = EMPConstants.InProgress;
                        if (ParentEntityId == (int)EMPConstants.Entity.SO)
                        {
                            customerInformation.AccountStatus = "Active";
                            customerInformation.StatusCode = EMPConstants.Active;
                            customerInformation.IsActivationCompleted = 1;
                        }

                        customerInformation.CreatedDate = DateTime.Now;
                        customerInformation.CreatedBy = model.UserId;
                        db.emp_CustomerInformation.Add(customerInformation);
                    }

                    try
                    {
                        db.SaveChanges();

                        if (customerInformation != null)
                        {
                            if (customerInformation.ParentId != Guid.Empty)
                            {
                                DropDownService ddService = new DropDownService();
                                var items = ddService.GetBottomToTopHierarchy(customerInformation.Id);
                            }
                        }


                        if (EntityTypeC != (int)System.Data.Entity.EntityState.Modified)
                        {
                            CreateNewUserResponse newuser = new CreateNewUserResponse();
                            if (customerInformation.ParentId.HasValue)
                            {
                                CreateNewUserModel userModel = new CreateNewUserModel();
                                userModel.MasterIdentifier = "";
                                userModel.AddBusinessProduct = false;
                                userModel.CompanyName = model.CompanyName;
                                userModel.Email = model.Primaryemail;
                                userModel.Fname = model.BusinessOwnerFirstName;
                                userModel.Lname = model.BusinessOwnerFirstName;
                                userModel.Phone = model.OfficePhone;
                                userModel.ShippingAddress = model.ShippingAddress1;
                                userModel.ShippingCity = model.ShippingCity; ;
                                userModel.ShippingState = model.ShippingState;
                                userModel.ShippingZip = model.ShippingZipcode;
                                userModel.ParentCustomerId = customerInformation.ParentId.Value;
                                userModel.CustomerId = customerInformation.Id;
                                newuser = CreateNewUser(userModel);
                            }

                            db = new DatabaseEntities();
                            emp_CustomerLoginInformation oLogin = new emp_CustomerLoginInformation();
                            oLogin.Id = Guid.NewGuid();
                            oLogin.EFIN = customerInformation.EFIN;
                            oLogin.MasterIdentifier = customerInformation.MasterIdentifier;
                            oLogin.OfficePortalUrl = "https://www.mytaxofficeportal.com";
                            oLogin.CreatedBy = model.UserId;
                            oLogin.CreatedDate = System.DateTime.Now;
                            oLogin.CustomerOfficeId = customerInformation.Id;



                            oLogin.StatusCode = EMPConstants.InProgress;
                            oLogin.LastUpdatedBy = model.UserId;
                            oLogin.LastUpdatedDate = System.DateTime.Now;
                            if (newuser.Status)
                            {
                                oLogin.CrossLinkUserId = newuser.UserId;
                                string Password = PasswordManager.CryptText(newuser.Password);

                                oLogin.CrossLinkPassword = Password;
                                oLogin.EMPPassword = Password;
                                oLogin.EMPUserId = newuser.UserId;
                                oLogin.StatusCode = EMPConstants.Active;

                                var officeinfo = db.emp_CustomerInformation.Where(x => x.Id == customerInformation.Id).FirstOrDefault();
                                officeinfo.StatusCode = EMPConstants.Created;

                            }
                            else
                            {
                                if (ParentEntityId == (int)EMPConstants.Entity.SO)
                                {
                                    EMPCustomerLogin EMPCustomer = GetEMPCustomerLogin(model.ParentId ?? Guid.Empty);
                                    oLogin.CrossLinkPassword = EMPCustomer.EMPPassword;
                                    oLogin.CrossLinkUserId = EMPCustomer.EMPUserId;
                                    oLogin.EMPPassword = EMPCustomer.EMPPassword;
                                    oLogin.EMPUserId = EMPCustomer.EMPUserId;
                                    oLogin.StatusCode = EMPConstants.Active;
                                }
                            }


                            db.emp_CustomerLoginInformation.Add(oLogin);
                            db.SaveChanges();

                            if (newuser.Status)
                            {
                                SendEmailForNewUser(new NewUserEmailRequest() { CustomerId = customerInformation.Id, UserId = model.UserId });
                                CustomerInfoDisplayDTO.StatusCode = "3";
                            }

                            if (IsAdditionalEFINSubSite)
                            {
                                if ((customerInformation.ParentId ?? Guid.Empty) != Guid.Empty)
                                {
                                    SaveExistingForAdditionalEFINSubSite(customerInformation.Id, customerInformation.ParentId ?? Guid.Empty, model.UserId ?? Guid.Empty);
                                }
                            }
                            //else
                            //{
                            //    if ((customerInformation.ParentId ?? Guid.Empty) != Guid.Empty)
                            //    {
                            //        SaveExistingForSubSite(customerInformation.Id, customerInformation.ParentId ?? Guid.Empty);
                            //    }
                            //}
                        }
                        else
                        {
                            db = new DatabaseEntities();
                            var CustLoginInfo = db.emp_CustomerLoginInformation.Where(a => a.CustomerOfficeId == id).FirstOrDefault();
                            if (CustLoginInfo != null)
                            {
                                CustLoginInfo.EFIN = customerInformation.EFIN;
                                CustLoginInfo.LastUpdatedBy = model.UserId;
                                CustLoginInfo.LastUpdatedDate = System.DateTime.Now;
                                db.Entry(CustLoginInfo).State = System.Data.Entity.EntityState.Modified;
                                db.SaveChanges();
                            }
                        }

                        db.Dispose();

                        if (EntityTypeC == (int)System.Data.Entity.EntityState.Modified)
                        {
                            CustomerInfoDisplayDTO.StatusCode = "2";
                            CustomerInfoDisplayDTO.EntityId = customerInformation.EntityId.ToString();
                            return CustomerInfoDisplayDTO;
                        }
                        else
                        {
                            CustomerInfoDisplayDTO.Id = customerInformation.Id.ToString();
                            CustomerInfoDisplayDTO.EntityId = customerInformation.EntityId.ToString();
                            CustomerInfoDisplayDTO.DisplayId = BaseEntityId;
                            return CustomerInfoDisplayDTO;
                        }


                    }
                    catch (DbUpdateConcurrencyException ex)
                    {
                        CustomerInfoDisplayDTO.StatusCode = "0";
                        return CustomerInfoDisplayDTO;
                    }
                }

                CustomerInfoDisplayDTO.StatusCode = "0";
                return CustomerInfoDisplayDTO;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/Save", id);
                return new CustomerInformationDisplayDTO();
            }
        }

        public bool UpdateSubSiteCustomerInfo(Guid Id, Guid ParentId)
        {
            try
            {
                bool iretval = false;
                try
                {
                    string StatusCode = "";

                    emp_CustomerLoginInformation customer_login = db.emp_CustomerLoginInformation.Where(e => e.CustomerOfficeId == Id).FirstOrDefault();
                    customer_login.StatusCode = EMPConstants.Active;

                    StatusCode = EMPConstants.NewCustomer;


                    var parentdata = db.emp_CustomerInformation
          .Join(db.emp_CustomerLoginInformation, custinfo => custinfo.Id, custlog => custlog.CustomerOfficeId,
                              (custinfo, custlog) => new { custinfo, custlog })
          .Where(o => o.custinfo.Id == ParentId)
          .Select(g => new
          {
              Id = g.custinfo.Id,
              CrossLinkUserId = g.custlog.CrossLinkUserId,
              IsMsoUser = g.custinfo.IsMSOUser ?? false,
              ParentId = g.custinfo.ParentId ?? Guid.Empty
          }).FirstOrDefault();


                    if (parentdata != null)
                    {
                        Guid NewParentId = Guid.Empty;
                        bool IsMSOorAdditionalEFINSubSite = false;

                        IsMSOorAdditionalEFINSubSite = parentdata.IsMsoUser;

                        if (!parentdata.IsMsoUser && parentdata.ParentId != Guid.Empty)
                        {
                            var SubSiteOfficeCofig = db.SubSiteOfficeConfigs.Where(o => o.RefId == ParentId).FirstOrDefault();
                            if (SubSiteOfficeCofig != null)
                            {
                                if (SubSiteOfficeCofig.SOorSSorEFIN == 3)
                                {
                                    NewParentId = ParentId;// parentdata.ParentId;
                                    IsMSOorAdditionalEFINSubSite = true;
                                }
                            }
                        }
                        else
                        {
                            NewParentId = ParentId;
                        }


                        if (IsMSOorAdditionalEFINSubSite)
                        {
                            var parentdata2 = db.emp_CustomerInformation
                                 .Join(db.emp_CustomerLoginInformation, custinfo => custinfo.Id, custlog => custlog.CustomerOfficeId,
                                                     (custinfo, custlog) => new { custinfo, custlog })
                                 .Where(o => o.custinfo.ParentId == NewParentId && o.custlog.CrossLinkUserId != null)
                                 .Select(g => new
                                 {
                                     CrossLinkUserId = g.custlog.CrossLinkUserId,
                                 }).ToList();

                            string UserIdChar = "A";
                            if (parentdata2.ToList().Count > 0)
                            {
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "A")).ToList().Count > 0)
                                {
                                    UserIdChar = "B";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "B")).ToList().Count > 0)
                                {
                                    UserIdChar = "C";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "C")).ToList().Count > 0)
                                {
                                    UserIdChar = "D";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "D")).ToList().Count > 0)
                                {
                                    UserIdChar = "E";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "E")).ToList().Count > 0)
                                {
                                    UserIdChar = "F";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "F")).ToList().Count > 0)
                                {
                                    UserIdChar = "G";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "G")).ToList().Count > 0)
                                {
                                    UserIdChar = "H";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "H")).ToList().Count > 0)
                                {
                                    UserIdChar = "I";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "I")).ToList().Count > 0)
                                {
                                    UserIdChar = "J";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "J")).ToList().Count > 0)
                                {
                                    UserIdChar = "K";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "K")).ToList().Count > 0)
                                {
                                    UserIdChar = "L";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "L")).ToList().Count > 0)
                                {
                                    UserIdChar = "M";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "M")).ToList().Count > 0)
                                {
                                    UserIdChar = "N";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "N")).ToList().Count > 0)
                                {
                                    UserIdChar = "O";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "O")).ToList().Count > 0)
                                {
                                    UserIdChar = "P";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "P")).ToList().Count > 0)
                                {
                                    UserIdChar = "Q";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "Q")).ToList().Count > 0)
                                {
                                    UserIdChar = "R";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "R")).ToList().Count > 0)
                                {
                                    UserIdChar = "S";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "S")).ToList().Count > 0)
                                {
                                    UserIdChar = "T";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "T")).ToList().Count > 0)
                                {
                                    UserIdChar = "U";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "U")).ToList().Count > 0)
                                {
                                    UserIdChar = "V";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "V")).ToList().Count > 0)
                                {
                                    UserIdChar = "W";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "W")).ToList().Count > 0)
                                {
                                    UserIdChar = "X";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "X")).ToList().Count > 0)
                                {
                                    UserIdChar = "Y";
                                }
                                if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "Y")).ToList().Count > 0)
                                {
                                    UserIdChar = "Z";
                                }
                            }

                            customer_login.CrossLinkUserId = parentdata.CrossLinkUserId + UserIdChar;
                            customer_login.EMPUserId = parentdata.CrossLinkUserId + UserIdChar;

                            var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                            var stringChars = new char[8];
                            var random = new Random();

                            for (int i = 0; i < stringChars.Length; i++)
                            {
                                stringChars[i] = chars[random.Next(chars.Length)];
                            }

                            var finalString = new String(stringChars);
                            string Password = PasswordManager.CryptText(finalString);
                            customer_login.CrossLinkPassword = Password;
                            customer_login.EMPPassword = Password;
                            customer_login.StatusCode = EMPConstants.Active;
                            StatusCode = EMPConstants.Created;
                        }
                    }

                    db.SaveChanges();

                    emp_CustomerInformation customerInformation = db.emp_CustomerInformation.Where(e => e.Id == Id).FirstOrDefault();
                    customerInformation.StatusCode = StatusCode;
                    customerInformation.AccountStatus = "Active";
                    customerInformation.IsActivationCompleted = 1;
                    customerInformation.LastUpdatedDate = System.DateTime.Now;

                    db.SaveChanges();
                    db.Dispose();

                    if (customerInformation != null)
                    {
                        DropDownService ddService = new DropDownService();
                        var items = ddService.GetBottomToTopHierarchy(customerInformation.Id);
                    }

                    iretval = true;

                }
                catch (Exception ex)
                {
                    iretval = false;
                    throw;
                }
                return iretval;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/UpdateSubSiteCustomerInfo", Id);
                return false;
            }
        }

        private bool emp_CustomerInformationExists(Guid id)
        {
            return db.emp_CustomerInformation.Count(e => e.Id == id) > 0;
        }

        public async Task<CustomerModel> GetCustomerInformationWithSalyesYearID(Guid SYGrpId, Guid SalesYearId)
        {
            try
            {
                var data = await (from e in db.emp_CustomerInformation
                                  join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                  where e.SalesYearGroupId == SYGrpId && e.SalesYearID == SalesYearId && e.StatusCode != EMPConstants.InActive
                                  select new CustomerModel
                                  {
                                      Id = e.Id,
                                      ParentId = e.ParentId ?? Guid.Empty,
                                      EntityId = e.EntityId ?? 0,
                                      SalesYearGroupId = e.SalesYearGroupId ?? Guid.Empty,
                                      BaseEntityId = db.EntityMasters.Where(o => o.Id == e.EntityId).Select(o => o.BaseEntityId).FirstOrDefault(),
                                      CompanyName = e.CompanyName,
                                      AccountStatus = e.AccountStatus,
                                      Feeder = e.Feeder,
                                      BusinessOwnerFirstName = e.BusinessOwnerFirstName,
                                      OfficePhone = e.OfficePhone,
                                      AlternatePhone = e.AlternatePhone,
                                      Primaryemail = e.PrimaryEmail,
                                      SupportNotificationemail = e.SupportNotificationEmail,
                                      EROType = e.EROType,
                                      AlternativeContact = e.AlternativeContact,
                                      EFIN = e.EFIN,
                                      PhysicalAddress1 = e.PhysicalAddress1,
                                      PhysicalAddress2 = e.PhysicalAddress2,
                                      PhysicalZipcode = e.PhysicalZipCode,
                                      PhysicalCity = e.PhysicalCity,
                                      PhysicalState = e.PhysicalState,
                                      ShippingAddress1 = e.ShippingAddress1,
                                      ShippingAddress2 = e.ShippingAddress2,
                                      ShippingZipcode = e.ShippingZipCode,
                                      ShippingCity = e.ShippingCity,
                                      ShippingState = e.ShippingState,
                                      PhoneTypeId = e.PhoneTypeId,
                                      TitleId = e.TitleId,
                                      IsVerified = e.IsVerified,
                                      // PhoneType = db.PhoneTypeMasters.Where(a => a.Id == e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault(),
                                      // ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault(),

                                      SalesYearID = e.SalesYearID ?? Guid.Empty,
                                      SalesforceParentID = e.SalesforceParentID,
                                      IsMSOUser = e.IsMSOUser ?? false,

                                      LoginId = cli.Id.ToString(),
                                      LoginEFIN = cli.EFIN,
                                      MasterIdentifier = cli.MasterIdentifier,
                                      CrossLinkUserId = cli.CrossLinkUserId,
                                      CrossLinkPassword = cli.CrossLinkPassword,
                                      OfficePortalUrl = cli.OfficePortalUrl,
                                      TaxOfficeUsername = cli.TaxOfficeUsername,
                                      TaxOfficePassword = cli.TaxOfficePassword,
                                      CustomerOfficeId = cli.CustomerOfficeId,


                                  }).Distinct().FirstOrDefaultAsync();
                return data;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetCustomerInformationWithSalyesYearID", Guid.Empty);
                return null;
            }
        }

        /// <summary>
        /// This method is used to get search customer informatation
        /// </summary>
        /// <param name="UserName"></param>
        /// <returns></returns>

        public IQueryable<CustomerModel> GetSearchCustomerInformation(Guid UserName)
        {
            try
            {

                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where e.ParentId == null && cli.CrossLinkUserId != null
                            && e.StatusCode != EMPConstants.NewCustomer
                            select new { e, cli }).ToList();
                if (data.Count > 0)
                {
                    if (data.Any(a => a.cli.CustomerOfficeId == UserName))
                    {
                        data = data.Where(a => a.cli.CustomerOfficeId == UserName).ToList();
                    }
                }
                List<CustomerModel> customerlst = new List<CustomerModel>();
                foreach (var itm in data)
                {
                    CustomerModel ocustomer = new CustomerModel();
                    ocustomer.Id = itm.e.Id;
                    ocustomer.ParentId = itm.e.ParentId ?? Guid.Empty;
                    ocustomer.CompanyName = itm.e.CompanyName;
                    ocustomer.AccountStatus = itm.e.AccountStatus;
                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    ocustomer.MasterIdentifier = itm.e.MasterIdentifier;
                    ocustomer.Feeder = itm.e.Feeder;
                    ocustomer.BusinessOwnerFirstName = itm.e.BusinessOwnerFirstName;
                    ocustomer.OfficePhone = itm.e.OfficePhone;
                    ocustomer.AlternatePhone = itm.e.AlternatePhone;
                    ocustomer.Primaryemail = itm.e.PrimaryEmail;
                    ocustomer.SupportNotificationemail = itm.e.SupportNotificationEmail;
                    ocustomer.EROType = itm.e.EROType;
                    ocustomer.AlternativeContact = itm.e.AlternativeContact ?? "";
                    ocustomer.EFIN = itm.e.EFIN;
                    ocustomer.PhysicalAddress1 = itm.e.PhysicalAddress1;
                    ocustomer.PhysicalAddress2 = itm.e.PhysicalAddress2;
                    ocustomer.PhysicalZipcode = itm.e.PhysicalZipCode;
                    ocustomer.PhysicalCity = itm.e.PhysicalCity;
                    ocustomer.PhysicalState = itm.e.PhysicalState;
                    ocustomer.ShippingAddress1 = itm.e.ShippingAddress1;
                    ocustomer.ShippingAddress2 = itm.e.ShippingAddress2;
                    ocustomer.ShippingZipcode = itm.e.ShippingZipCode;
                    ocustomer.ShippingCity = itm.e.ShippingCity;
                    ocustomer.ShippingState = itm.e.ShippingState;
                    ocustomer.PhoneTypeId = itm.e.PhoneTypeId;
                    ocustomer.TitleId = itm.e.TitleId;
                    ocustomer.AlternativeType = itm.e.AlternativeType;
                    ocustomer.PhoneType = db.PhoneTypeMasters.Where(a => a.Id == itm.e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault();
                    ocustomer.ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == itm.e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault() ?? "";
                    ocustomer.EntityId = itm.e.EntityId ?? 0;
                    ocustomer.SalesYearID = itm.e.SalesYearID ?? Guid.Empty;
                    ocustomer.BaseEntityId = db.EntityMasters.Where(a => a.Id == itm.e.EntityId).Select(a => a.BaseEntityId).FirstOrDefault();
                    ocustomer.LoginId = itm.cli.Id.ToString();
                    ocustomer.LoginEFIN = itm.cli.EFIN;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.CrossLinkUserId = itm.cli.CrossLinkUserId ?? "";
                    ocustomer.CrossLinkPassword = itm.cli.CrossLinkPassword;
                    ocustomer.OfficePortalUrl = itm.cli.OfficePortalUrl;
                    ocustomer.TaxOfficeUsername = itm.cli.TaxOfficeUsername;
                    ocustomer.TaxOfficePassword = itm.cli.TaxOfficePassword;
                    ocustomer.CustomerOfficeId = itm.cli.CustomerOfficeId;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.IsActivationCompleted = itm.e.IsActivationCompleted ?? 0;
                    ocustomer.ChaildCustomerInfoCount = db.emp_CustomerInformation.Where(a => a.ParentId == itm.e.Id).Count();
                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    if (itm.e.IsActivationCompleted == null || itm.e.IsActivationCompleted == 0)
                        ocustomer.ActivationStatus = "Not Active";
                    else
                        ocustomer.ActivationStatus = "Active";

                    ocustomer.CreatedDate = itm.cli.CreatedDate ?? Convert.ToDateTime("01/01/2000");
                    ocustomer.LastUpdatedDate = itm.e.LastUpdatedDate ?? Convert.ToDateTime("01/01/2000");

                    //var CustFees = CustomerFees(itm.e.Id);
                    //foreach (var fees in CustFees)
                    //{
                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                    //    {
                    //        ocustomer.TotalServiceFee = fees.Amount;
                    //        ocustomer.ServiceTooltip = fees.FeesName;
                    //    }

                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                    //    {
                    //        ocustomer.TotalTransFee = fees.Amount;
                    //        ocustomer.TransTooltip = fees.FeesName;
                    //    }
                    //}
                    //var BankFees = BankFee(itm.e.Id, itm.e.Id, ocustomer.CompanyName, ocustomer.CompanyName, 0);
                    //foreach (var fees in BankFees)
                    //{
                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                    //    {
                    //        ocustomer.TotalServiceFee = ocustomer.TotalServiceFee + fees.Amount;
                    //        ocustomer.ServiceTooltip = ocustomer.ServiceTooltip + fees.FeesName;
                    //    }

                    //    if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                    //    {
                    //        ocustomer.TotalTransFee = ocustomer.TotalTransFee + fees.Amount;
                    //        ocustomer.TransTooltip = ocustomer.TransTooltip + fees.FeesName;
                    //    }
                    //}


                    if (ocustomer.EROType == "Single Office")
                        ocustomer.IsActivated = true;
                    else
                    {
                        ocustomer.IsActivated = itm.e.IsActivationCompleted.HasValue ? (itm.e.IsActivationCompleted.Value == 1 ? true : false) : false;
                    }
                    customerlst.Add(ocustomer);
                }
                return customerlst.OrderBy(a => a.CompanyName).AsQueryable();

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetSearchCustomerInformation", UserName);
                return new List<CustomerModel>().AsQueryable();
            }
        }

        public IQueryable<CustomerModel> GetSearchCustomerInformation(Guid UserName, string Status, string SiteType, string BankPartner, string EnrollmentStatus, string OnBoardingStatus, string SearchText, int SearchType)
        {
            try
            {

                //string Status, string SiteType, string BankPartner, string EnrollmentStatus, string OnBoardingStatus

                List<string> Statuslst = !string.IsNullOrEmpty(Status) ? Status.Split(',').ToList() : null;
                List<string> SiteTypelst = !string.IsNullOrEmpty(SiteType) ? SiteType.Split(',').ToList() : null;
                List<string> BankPartnerlst = !string.IsNullOrEmpty(BankPartner) ? BankPartner.Split(',').ToList() : null;
                List<string> EnrollmentStatuslst = !string.IsNullOrEmpty(EnrollmentStatus) ? EnrollmentStatus.Split(',').ToList() : null;
                List<string> OnBoardingStatuslst = !string.IsNullOrEmpty(OnBoardingStatus) ? OnBoardingStatus.Split(',').ToList() : null;

                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where e.ParentId == null && cli.CrossLinkUserId != null //&& e.AlternativeContact != null && e.AlternatePhone != null
                            && e.StatusCode != EMPConstants.NewCustomer
                            select new { e, cli }).ToList();
                if (data.Count > 0)
                {
                    if (data.Any(a => a.cli.CustomerOfficeId == UserName))
                    {
                        data = data.Where(a => a.cli.CustomerOfficeId == UserName).ToList();
                    }
                }
                List<CustomerModel> customerlst = new List<CustomerModel>();
                foreach (var itm in data)
                {
                    CustomerModel ocustomer = new CustomerModel();
                    ocustomer.Id = itm.e.Id;
                    ocustomer.ParentId = itm.e.ParentId ?? Guid.Empty;
                    ocustomer.CompanyName = itm.e.CompanyName;
                    ocustomer.AccountStatus = itm.e.AccountStatus;
                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    ocustomer.MasterIdentifier = itm.e.MasterIdentifier;
                    ocustomer.Feeder = itm.e.Feeder;
                    ocustomer.BusinessOwnerFirstName = itm.e.BusinessOwnerFirstName;
                    ocustomer.OfficePhone = itm.e.OfficePhone;
                    ocustomer.AlternatePhone = itm.e.AlternatePhone;
                    ocustomer.Primaryemail = itm.e.PrimaryEmail;
                    ocustomer.SupportNotificationemail = itm.e.SupportNotificationEmail;
                    ocustomer.EROType = itm.e.EROType;
                    ocustomer.AlternativeContact = itm.e.AlternativeContact ?? "";
                    ocustomer.EFIN = itm.e.EFIN;
                    ocustomer.PhysicalAddress1 = itm.e.PhysicalAddress1;
                    ocustomer.PhysicalAddress2 = itm.e.PhysicalAddress2;
                    ocustomer.PhysicalZipcode = itm.e.PhysicalZipCode;
                    ocustomer.PhysicalCity = itm.e.PhysicalCity;
                    ocustomer.PhysicalState = itm.e.PhysicalState;
                    ocustomer.ShippingAddress1 = itm.e.ShippingAddress1;
                    ocustomer.ShippingAddress2 = itm.e.ShippingAddress2;
                    ocustomer.ShippingZipcode = itm.e.ShippingZipCode;
                    ocustomer.ShippingCity = itm.e.ShippingCity;
                    ocustomer.ShippingState = itm.e.ShippingState;
                    ocustomer.PhoneTypeId = itm.e.PhoneTypeId;
                    ocustomer.TitleId = itm.e.TitleId;
                    ocustomer.AlternativeType = itm.e.AlternativeType;
                    ocustomer.PhoneType = db.PhoneTypeMasters.Where(a => a.Id == itm.e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault();
                    ocustomer.ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == itm.e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault() ?? "";
                    ocustomer.EntityId = itm.e.EntityId ?? 0;
                    ocustomer.SalesYearID = itm.e.SalesYearID ?? Guid.Empty;
                    ocustomer.BaseEntityId = db.EntityMasters.Where(a => a.Id == itm.e.EntityId).Select(a => a.BaseEntityId).FirstOrDefault();
                    ocustomer.LoginId = itm.cli.Id.ToString();
                    ocustomer.LoginEFIN = itm.cli.EFIN;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.CrossLinkUserId = itm.cli.CrossLinkUserId ?? "";
                    ocustomer.CrossLinkPassword = itm.cli.CrossLinkPassword;
                    ocustomer.OfficePortalUrl = itm.cli.OfficePortalUrl;
                    ocustomer.TaxOfficeUsername = itm.cli.TaxOfficeUsername;
                    ocustomer.TaxOfficePassword = itm.cli.TaxOfficePassword;
                    ocustomer.CustomerOfficeId = itm.cli.CustomerOfficeId;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.IsActivationCompleted = itm.e.IsActivationCompleted ?? 0;

                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    if (itm.e.IsActivationCompleted == null || itm.e.IsActivationCompleted == 0)
                        ocustomer.ActivationStatus = "Not Active";
                    else
                        ocustomer.ActivationStatus = "Active";

                    ocustomer.CreatedDate = itm.cli.CreatedDate ?? Convert.ToDateTime("01/01/2000");
                    ocustomer.LastUpdatedDate = itm.e.LastUpdatedDate ?? Convert.ToDateTime("01/01/2000");

                    ocustomer.IsEnrolled = itm.e.IsEnrolled ?? false;
                    ocustomer.EnrolledBankId = itm.e.EnrolledBankId;

                    EnrollmentBankSelectionService serv = new EnrollmentBankSelectionInfo.EnrollmentBankSelectionService();
                    var enrdata = serv.getEnrollmentStatusInfo(ocustomer.Id);
                    ocustomer.ActiveBank = enrdata.BankName;
                    ocustomer.SubmissionDate = enrdata.SubmitedDate;
                    ocustomer.EnrollmentStatus = enrdata.SubmissionStaus;
                    ocustomer.ApprovedBank = enrdata.ApprovedBank;
                    ocustomer.RejectedBanks = enrdata.RejectedBanks;
                    ocustomer.UnlockedBanks = enrdata.UnlockedBanks;

                    var ChildDataLst = GetChildCustomerInfo(itm.e.Id, itm.e.CompanyName, Statuslst, SiteTypelst, SearchText, SearchType, UserName);
                    ocustomer.ChaildCustomerInfo = ChildDataLst;

                    if (ocustomer.EROType == "Single Office")
                        ocustomer.IsActivated = true;
                    else
                    {
                        ocustomer.IsActivated = itm.e.IsActivationCompleted.HasValue ? (itm.e.IsActivationCompleted.Value == 1 ? true : false) : false;
                    }

                    customerlst.Add(ocustomer);
                }

                if (Statuslst != null)
                {
                    customerlst = customerlst.Where(o => Statuslst.Contains(o.StatusCode) || o.ChaildCustomerInfo.Count > 0).ToList();
                }
                if (SiteTypelst != null)
                {
                    customerlst = customerlst.Where(o => SiteTypelst.Contains(o.EntityId.ToString()) || o.ChaildCustomerInfo.Count > 0).ToList();
                }

                if (SearchType > 0)
                {
                    if (SearchType == 1)
                    {
                        customerlst = customerlst.Where(o => o.CompanyName.ToString().ToLower().Contains(SearchText.ToLower()) || o.ChaildCustomerInfo.Count > 0).ToList();
                    }
                    else if (SearchType == 2)
                    {
                        customerlst = customerlst.Where(o => o.CrossLinkUserId.ToString().ToLower().Contains(SearchText.ToLower()) || o.ChaildCustomerInfo.Count > 0).ToList();
                    }
                    else if (SearchType == 3)
                    {
                        customerlst = customerlst.Where(o => o.EFIN.ToString().ToLower().Contains(SearchText.ToLower()) || o.ChaildCustomerInfo.Count > 0).ToList();
                    }
                    else if (SearchType == 4)
                    {
                        customerlst = customerlst.Where(o => o.AlternativeContact != null ? o.AlternativeContact.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternativeContact == o.AlternativeContact).ToList();
                    }
                    else if (SearchType == 5)
                    {
                        customerlst = customerlst.Where(o => o.AlternatePhone != null ? o.AlternatePhone.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternatePhone == o.AlternatePhone).ToList();
                    }
                }
                return customerlst.OrderBy(a => a.CompanyName).AsQueryable();

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetSearchCustomerInformation", UserName);
                return new List<CustomerModel>().AsQueryable();
            }
        }

        public List<CustomerModel> GetChildCustomerInfo(Guid id, string companyname, List<string> Statuslst, List<string> SiteTypelst, string SearchText, int SearchType, Guid LoginUserId)
        {
            try
            {
                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where e.ParentId == id &&
                            //cli.CrossLinkUserId != null && e.AlternativeContact != null && e.AlternatePhone != null && 
                            e.StatusCode != EMPConstants.NewCustomer
                            && e.IsActivationCompleted == 1
                            select new { e, cli });
                List<CustomerModel> customerlst = new List<CustomerModel>();
                if (data != null)
                {
                    foreach (var itm in data)
                    {
                        CustomerModel ocustomer = new CustomerModel();
                        ocustomer.Id = itm.e.Id;
                        ocustomer.ParentId = itm.e.ParentId ?? Guid.Empty;
                        ocustomer.CompanyName = itm.e.CompanyName;
                        ocustomer.AccountStatus = itm.e.AccountStatus;
                        ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                        ocustomer.MasterIdentifier = itm.e.MasterIdentifier;
                        ocustomer.Feeder = itm.e.Feeder;
                        ocustomer.BusinessOwnerFirstName = itm.e.BusinessOwnerFirstName;
                        ocustomer.OfficePhone = itm.e.OfficePhone;
                        ocustomer.AlternatePhone = itm.e.AlternatePhone;
                        ocustomer.Primaryemail = itm.e.PrimaryEmail;
                        ocustomer.SupportNotificationemail = itm.e.SupportNotificationEmail;
                        ocustomer.EROType = itm.e.EROType;
                        ocustomer.AlternativeContact = itm.e.AlternativeContact ?? "";
                        ocustomer.EFIN = itm.e.EFIN;
                        ocustomer.PhysicalAddress1 = itm.e.PhysicalAddress1;
                        ocustomer.PhysicalAddress2 = itm.e.PhysicalAddress2;
                        ocustomer.PhysicalZipcode = itm.e.PhysicalZipCode;
                        ocustomer.PhysicalCity = itm.e.PhysicalCity;
                        ocustomer.PhysicalState = itm.e.PhysicalState;
                        ocustomer.ShippingAddress1 = itm.e.ShippingAddress1;
                        ocustomer.ShippingAddress2 = itm.e.ShippingAddress2;
                        ocustomer.ShippingZipcode = itm.e.ShippingZipCode;
                        ocustomer.ShippingCity = itm.e.ShippingCity;
                        ocustomer.ShippingState = itm.e.ShippingState;
                        ocustomer.PhoneTypeId = itm.e.PhoneTypeId;
                        ocustomer.TitleId = itm.e.TitleId;
                        ocustomer.PhoneType = db.PhoneTypeMasters.Where(a => a.Id == itm.e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault();
                        ocustomer.ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == itm.e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault();
                        ocustomer.EntityId = itm.e.EntityId ?? 0;
                        ocustomer.BaseEntityId = db.EntityMasters.Where(a => a.Id == itm.e.EntityId).Select(a => a.BaseEntityId).FirstOrDefault();

                        ocustomer.SalesYearID = itm.e.SalesYearID ?? Guid.Empty;
                        ocustomer.StatusCode = itm.e.StatusCode;
                        ocustomer.LoginId = itm.cli.Id.ToString();
                        ocustomer.LoginEFIN = itm.cli.EFIN;
                        ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                        ocustomer.CrossLinkUserId = itm.cli.CrossLinkUserId ?? "";
                        ocustomer.CrossLinkPassword = itm.cli.CrossLinkPassword;
                        ocustomer.EMPUserId = itm.cli.EMPUserId;
                        ocustomer.EMPPassword = itm.cli.EMPPassword;
                        ocustomer.OfficePortalUrl = itm.cli.OfficePortalUrl;
                        ocustomer.TaxOfficeUsername = itm.cli.TaxOfficeUsername;
                        ocustomer.TaxOfficePassword = itm.cli.TaxOfficePassword;
                        ocustomer.CustomerOfficeId = itm.cli.CustomerOfficeId;

                        ocustomer.IsActivationCompleted = itm.e.IsActivationCompleted ?? 0;

                        var SubOfficeConfig = db.SubSiteOfficeConfigs.Where(o => o.RefId == ocustomer.Id).FirstOrDefault();
                        if (SubOfficeConfig != null)
                        {
                            if (SubOfficeConfig.SOorSSorEFIN == 3)
                            {
                                ocustomer.IsAdditionalEFINAllowed = true;
                            }
                        }

                        ocustomer.CreatedDate = itm.cli.CreatedDate ?? Convert.ToDateTime("01/01/2000");
                        ocustomer.LastUpdatedDate = itm.e.LastUpdatedDate ?? Convert.ToDateTime("01/01/2000");
                        if (itm.e.IsActivationCompleted == null || itm.e.IsActivationCompleted == 0)
                            ocustomer.ActivationStatus = "Not Active";
                        else
                            ocustomer.ActivationStatus = "Active";

                        ocustomer.IsEnrolled = itm.e.IsEnrolled ?? false;
                        ocustomer.EnrolledBankId = itm.e.EnrolledBankId;

                        if (ocustomer.IsEnrolled)
                        {
                            var BankFees = BankFee(itm.e.Id, id, itm.e.CompanyName, companyname, 1, itm.e.IsMSOUser ?? false);
                            foreach (var fees in BankFees)
                            {
                                if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                                {
                                    ocustomer.TotalServiceFee = ocustomer.TotalServiceFee + fees.Amount;
                                    ocustomer.ServiceTooltip = ocustomer.ServiceTooltip + fees.FeesName;
                                }

                                if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                                {
                                    ocustomer.TotalTransFee = ocustomer.TotalTransFee + fees.Amount;
                                    ocustomer.TransTooltip = ocustomer.TransTooltip + fees.FeesName;
                                }
                            }
                        }

                        #region "Actions"
                        var actions = (from s in db.EMP_ActionMaser
                                       where s.EntityId == itm.e.EntityId && s.Status == EMPConstants.Active
                                       orderby s.DisplayOrder
                                       select new Actions
                                       {
                                           IsParent = s.ParentId,
                                           Name = s.Name,
                                           Display = s.ForActive
                                       }).ToList();

                        ocustomer.Actions = actions;
                        #endregion

                        //if (ocustomer.IsAdditionalEFINAllowed)
                        //{
                        ocustomer.ChaildCustomerInfo = new List<CustomerInformation.CustomerModel>();
                        //ocustomer.ChaildCustomerInfo = GetChildCustomerInfo_AdditionalEFIN(itm.e.Id, id, itm.e.CompanyName, companyname, Statuslst, SiteTypelst, SearchText, SearchType, LoginUserId);
                        ocustomer.ChaildCustomerInfo = GetChildCustomerInfo(itm.e.Id, "", null, null, "", 0, LoginUserId);
                        //}

                        if (itm.e.IsActivationCompleted == 1)
                        {
                            if (ocustomer.ParentId == LoginUserId)
                            {
                                //var isUtaxenroll = db.SubSiteConfigurations.Where(x => x.emp_CustomerInformation_ID == ocustomer.ParentId).Select(x => x.IsuTaxPortalEnrollment).FirstOrDefault();
                                //ocustomer.IsActivated = isUtaxenroll.HasValue ? isUtaxenroll.Value : false;
                                ocustomer.IsActivated = true;
                            }
                            else
                            {
                                var EntityHierarchyDTOs =new DropDownService().GetEntityHierarchies(ocustomer.Id);
                                var isUtaxenroll = db.SubSiteConfigurations.Where(x => x.emp_CustomerInformation_ID == ocustomer.ParentId).Select(x => x.IsuTaxManageingEnrolling).FirstOrDefault();
                                ocustomer.IsActivated = isUtaxenroll.HasValue ? isUtaxenroll.Value : false;
                            }
                        }

                        EnrollmentBankSelectionService serv = new EnrollmentBankSelectionInfo.EnrollmentBankSelectionService();
                        var enrdata = serv.getEnrollmentStatusInfo(ocustomer.Id);
                        ocustomer.ActiveBank = enrdata.BankName;
                        ocustomer.SubmissionDate = enrdata.SubmitedDate;
                        ocustomer.EnrollmentStatus = enrdata.SubmissionStaus;
                        ocustomer.ApprovedBank = enrdata.ApprovedBank;
                        ocustomer.RejectedBanks = enrdata.RejectedBanks;
                        ocustomer.UnlockedBanks = enrdata.UnlockedBanks;

                        customerlst.Add(ocustomer);
                    }

                    if (Statuslst != null)
                    {
                        customerlst = customerlst.Where(o => Statuslst.Contains(o.StatusCode)).ToList();
                    }
                    if (SiteTypelst != null)
                    {
                        customerlst = customerlst.Where(o => SiteTypelst.Contains(o.EntityId.ToString())).ToList();
                    }
                    if (SearchType > 0)
                    {
                        if (SearchType == 1)
                        {
                            customerlst = customerlst.Where(o => o.CompanyName.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                        }
                        else if (SearchType == 2)
                        {
                            customerlst = customerlst.Where(o => o.CrossLinkUserId != null ? o.CrossLinkUserId.ToString().ToLower().Contains(SearchText.ToLower()) : o.CrossLinkUserId == o.CrossLinkUserId).ToList();
                        }
                        else if (SearchType == 3)
                        {
                            customerlst = customerlst.Where(o => o.EFIN.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                        }
                        else if (SearchType == 4)
                        {
                            customerlst = customerlst.Where(o => o.AlternativeContact != null ? o.AlternativeContact.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternativeContact == o.AlternativeContact).ToList();
                        }
                        else if (SearchType == 5)
                        {
                            customerlst = customerlst.Where(o => o.AlternatePhone != null ? o.AlternatePhone.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternatePhone == o.AlternatePhone).ToList();
                        }
                    }
                }
                return customerlst;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetChildCustomerInfo", id);
                return new List<CustomerModel>();
            }
        }

        public List<CustomerModel> GetChildCustomerInfo_AdditionalEFIN(Guid id, Guid ParentId, string companyname, string ParentCompanyname, List<string> Statuslst, List<string> SiteTypelst, string SearchText, int SearchType, Guid LoginUserId)
        {
            try
            {

                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where e.ParentId == id //&& cli.CrossLinkUserId != null && e.AlternativeContact != null && e.AlternatePhone != null 
                            && e.StatusCode != EMPConstants.NewCustomer
                            && e.IsActivationCompleted == 1
                            select new { e, cli });
                List<CustomerModel> customerlst = new List<CustomerModel>();
                if (data != null)
                {
                    foreach (var itm in data)
                    {
                        CustomerModel ocustomer = new CustomerModel();
                        ocustomer.Id = itm.e.Id;
                        ocustomer.ParentId = itm.e.ParentId ?? Guid.Empty;
                        ocustomer.CompanyName = itm.e.CompanyName;
                        ocustomer.AccountStatus = itm.e.AccountStatus;
                        ocustomer.Feeder = itm.e.Feeder;
                        ocustomer.BusinessOwnerFirstName = itm.e.BusinessOwnerFirstName;
                        ocustomer.OfficePhone = itm.e.OfficePhone;
                        ocustomer.AlternatePhone = itm.e.AlternatePhone;
                        ocustomer.Primaryemail = itm.e.PrimaryEmail;
                        ocustomer.SupportNotificationemail = itm.e.SupportNotificationEmail;
                        ocustomer.EROType = itm.e.EROType;
                        ocustomer.AlternativeContact = itm.e.AlternativeContact ?? "";
                        ocustomer.EFIN = itm.e.EFIN;
                        ocustomer.PhysicalAddress1 = itm.e.PhysicalAddress1;
                        ocustomer.PhysicalAddress2 = itm.e.PhysicalAddress2;
                        ocustomer.PhysicalZipcode = itm.e.PhysicalZipCode;
                        ocustomer.PhysicalCity = itm.e.PhysicalCity;
                        ocustomer.PhysicalState = itm.e.PhysicalState;
                        ocustomer.ShippingAddress1 = itm.e.ShippingAddress1;
                        ocustomer.ShippingAddress2 = itm.e.ShippingAddress2;
                        ocustomer.ShippingZipcode = itm.e.ShippingZipCode;
                        ocustomer.ShippingCity = itm.e.ShippingCity;
                        ocustomer.ShippingState = itm.e.ShippingState;
                        ocustomer.PhoneTypeId = itm.e.PhoneTypeId;
                        ocustomer.TitleId = itm.e.TitleId;
                        ocustomer.PhoneType = db.PhoneTypeMasters.Where(a => a.Id == itm.e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault();
                        ocustomer.ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == itm.e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault();
                        ocustomer.EntityId = itm.e.EntityId ?? 0;
                        ocustomer.BaseEntityId = db.EntityMasters.Where(a => a.Id == itm.e.EntityId).Select(a => a.BaseEntityId).FirstOrDefault();

                        ocustomer.SalesYearID = itm.e.SalesYearID ?? Guid.Empty;
                        ocustomer.StatusCode = itm.e.StatusCode;
                        ocustomer.LoginId = itm.cli.Id.ToString();
                        ocustomer.LoginEFIN = itm.cli.EFIN;
                        ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                        ocustomer.CrossLinkUserId = itm.cli.CrossLinkUserId;
                        ocustomer.CrossLinkPassword = itm.cli.CrossLinkPassword != null ? PasswordManager.DecryptText(itm.cli.CrossLinkPassword.ToString()) : "";  //itm.cli.CrossLinkPassword;
                        ocustomer.EMPUserId = itm.cli.EMPUserId;
                        ocustomer.EMPPassword = itm.cli.EMPPassword != null ? PasswordManager.DecryptText(itm.cli.EMPPassword.ToString()) : ""; //itm.cli.EMPPassword;
                        ocustomer.OfficePortalUrl = itm.cli.OfficePortalUrl;
                        ocustomer.TaxOfficeUsername = itm.cli.TaxOfficeUsername;
                        ocustomer.TaxOfficePassword = itm.cli.TaxOfficePassword != null ? PasswordManager.DecryptText(itm.cli.TaxOfficePassword.ToString()) : ""; //itm.cli.TaxOfficePassword;
                        ocustomer.CustomerOfficeId = itm.cli.CustomerOfficeId;
                        ocustomer.IsAdditionalEFINAllowed = itm.e.IsAdditionalEFINAllowed ?? false;
                        ocustomer.IsActivationCompleted = itm.e.IsActivationCompleted ?? 0;
                        ocustomer.SalesforceParentID = itm.e.SalesforceParentID;

                        if (itm.e.IsActivationCompleted == null || itm.e.IsActivationCompleted == 0)
                            ocustomer.ActivationStatus = "Not Active";
                        else
                            ocustomer.ActivationStatus = "Active";

                        EnrollmentBankSelectionService serv = new EnrollmentBankSelectionInfo.EnrollmentBankSelectionService();
                        var enrdata = serv.getEnrollmentStatusInfo(ocustomer.Id);
                        ocustomer.ActiveBank = enrdata.BankName;
                        ocustomer.SubmissionDate = enrdata.SubmitedDate;
                        ocustomer.EnrollmentStatus = enrdata.SubmissionStaus;
                        ocustomer.ApprovedBank = enrdata.ApprovedBank;
                        ocustomer.RejectedBanks = enrdata.RejectedBanks;
                        ocustomer.UnlockedBanks = enrdata.UnlockedBanks;

                        //var CustFees = CustomerFees(id);
                        //foreach (var fees in CustFees)
                        //{
                        //    if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                        //    {
                        //        ocustomer.TotalServiceFee = fees.Amount;
                        //        ocustomer.ServiceTooltip = fees.FeesName;
                        //    }

                        //    if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                        //    {
                        //        ocustomer.TotalTransFee = fees.Amount;
                        //        ocustomer.TransTooltip = fees.FeesName;
                        //    }
                        //}
                        ocustomer.IsEnrolled = itm.e.IsEnrolled ?? false;
                        ocustomer.EnrolledBankId = itm.e.EnrolledBankId;

                        if (ocustomer.IsEnrolled)
                        {
                            var BankFees = BankFee(itm.e.Id, ParentId, itm.e.CompanyName, ParentCompanyname, 1, itm.e.IsMSOUser ?? false);
                            foreach (var fees in BankFees)
                            {
                                if (fees.FeeFor == (int)EMPConstants.FeesFor.SVBFees)
                                {
                                    ocustomer.TotalServiceFee = ocustomer.TotalServiceFee + fees.Amount;
                                    ocustomer.ServiceTooltip = ocustomer.ServiceTooltip + fees.FeesName;
                                }

                                if (fees.FeeFor == (int)EMPConstants.FeesFor.TransmissionFees)
                                {
                                    ocustomer.TotalTransFee = ocustomer.TotalTransFee + fees.Amount;
                                    ocustomer.TransTooltip = ocustomer.TransTooltip + fees.FeesName;
                                }
                            }
                        }

                        if (itm.e.IsActivationCompleted == 1)
                        {
                            if (ParentId == LoginUserId)
                            {
                                var isUtaxenroll = db.SubSiteConfigurations.Where(x => x.emp_CustomerInformation_ID == ParentId).Select(x => x.IsuTaxPortalEnrollment).FirstOrDefault();
                                //ocustomer.IsActivated = isUtaxenroll.HasValue ? isUtaxenroll.Value : false;
                                ocustomer.IsActivated = true;
                            }
                            else
                            {
                                var isUtaxenroll = db.SubSiteConfigurations.Where(x => x.emp_CustomerInformation_ID == ParentId).Select(x => x.IsuTaxManageingEnrolling).FirstOrDefault();
                                ocustomer.IsActivated = isUtaxenroll.HasValue ? isUtaxenroll.Value : false;
                            }
                        }

                        customerlst.Add(ocustomer);
                    }

                    if (Statuslst != null)
                    {
                        customerlst = customerlst.Where(o => Statuslst.Contains(o.StatusCode)).ToList();
                    }
                    if (SiteTypelst != null)
                    {
                        customerlst = customerlst.Where(o => SiteTypelst.Contains(o.EntityId.ToString())).ToList();
                    }
                    if (SearchType > 0)
                    {
                        if (SearchType == 1)
                        {
                            customerlst = customerlst.Where(o => o.CompanyName.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                        }
                        else if (SearchType == 2)
                        {
                            customerlst = customerlst.Where(o => o.CrossLinkUserId != null ? o.CrossLinkUserId.ToString().ToLower().Contains(SearchText.ToLower()) : o.CrossLinkUserId == o.CrossLinkUserId).ToList();
                        }
                        else if (SearchType == 3)
                        {
                            customerlst = customerlst.Where(o => o.EFIN.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                        }
                        else if (SearchType == 4)
                        {
                            customerlst = customerlst.Where(o => o.AlternativeContact != null ? o.AlternativeContact.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternativeContact == o.AlternativeContact).ToList();
                        }
                        else if (SearchType == 5)
                        {
                            customerlst = customerlst.Where(o => o.AlternatePhone != null ? o.AlternatePhone.ToString().ToLower().Contains(SearchText.ToLower()) : o.AlternatePhone == o.AlternatePhone).ToList();
                        }
                    }
                }

                return customerlst;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetChildCustomerInfo_AdditionalEFIN", id);
                return new List<CustomerModel>();
            }
        }

        ///Not In Used
        public int SaveCustomerSubSiteInfo(CustomerInformationModel model, Guid ParentId)
        {
            try
            {
                if (model != null)
                {
                    var isExist = db.emp_CustomerInformation.Any(a => a.EFIN == model.EFIN);

                    if (!isExist)
                    {

                        emp_CustomerInformation emp_Customerinfo = new emp_CustomerInformation();
                        emp_Customerinfo.Id = Guid.NewGuid();
                        emp_Customerinfo.CompanyName = model.CompanyName;
                        emp_Customerinfo.ParentId = model.ParentId;
                        emp_Customerinfo.AccountStatus = "Active";

                        var Entity = (from c in db.emp_CustomerInformation
                                      join e in db.EntityMasters on c.EntityId equals e.ParentId
                                      where c.Id == model.ParentId
                                      select new { e.BaseEntityId, e.Id, e.Name }).FirstOrDefault();

                        emp_Customerinfo.StatusCode = EMPConstants.NewCustomer;

                        if (Entity == null)
                        {
                            Entity = (from e in db.EntityMasters
                                      where e.BaseEntityId == (int)EMPConstants.BaseEntities.SOME
                                      select new { e.BaseEntityId, e.Id, e.Name }).FirstOrDefault();

                            emp_Customerinfo.StatusCode = EMPConstants.Created;
                        }

                        emp_Customerinfo.MasterIdentifier = model.MasterIdentifier;
                        emp_Customerinfo.SalesforceParentID = db.emp_CustomerLoginInformation.Where(a => a.CustomerOfficeId == model.ParentId).Select(a => a.CrossLinkUserId).FirstOrDefault();

                        emp_Customerinfo.EntityId = Entity.Id;
                        emp_Customerinfo.Feeder = true;
                        emp_Customerinfo.BusinessOwnerFirstName = model.BusinessOwnerFirstName;
                        emp_Customerinfo.OfficePhone = model.OfficePhone;
                        emp_Customerinfo.AlternatePhone = model.AlternatePhone;
                        emp_Customerinfo.PrimaryEmail = model.Primaryemail;

                        // if (EntName == 6)
                        emp_Customerinfo.EROType = Entity.Name;
                        // else if (EntName == 4)
                        //     emp_Customerinfo.EROType = "Mo Sub Office";
                        emp_Customerinfo.AlternativeContact = model.AlternativeContact;
                        emp_Customerinfo.EFIN = model.EFIN;
                        emp_Customerinfo.PhysicalAddress1 = model.PhysicalAddress1;
                        emp_Customerinfo.PhysicalZipCode = model.PhysicalZipcode;
                        emp_Customerinfo.PhysicalCity = model.PhysicalCity;
                        emp_Customerinfo.PhysicalState = model.PhysicalState;
                        emp_Customerinfo.PhoneTypeId = Guid.Empty;

                        var SalesYear = db.SalesYearMasters.Where(o => o.ApplicableToDate == null).FirstOrDefault();
                        if (SalesYear != null)
                        {
                            emp_Customerinfo.SalesYearID = SalesYear.Id;
                            emp_Customerinfo.SalesYearGroupId = emp_Customerinfo.Id;
                        }

                        emp_Customerinfo.CreatedBy = model.UserId ?? Guid.Empty;
                        emp_Customerinfo.CreatedDate = DateTime.Now;
                        emp_Customerinfo.LastUpdatedDate = DateTime.Now;
                        emp_Customerinfo.LastUpdatedBy = model.UserId ?? Guid.Empty;

                        try
                        {
                            db.emp_CustomerInformation.Add(emp_Customerinfo);

                            emp_CustomerLoginInformation emp_CustomerLoginInfo = new emp_CustomerLoginInformation();
                            emp_CustomerLoginInfo.Id = Guid.NewGuid();
                            emp_CustomerLoginInfo.CustomerOfficeId = emp_Customerinfo.Id;
                            emp_CustomerLoginInfo.EFIN = model.EFIN;

                            if (Entity.BaseEntityId == (int)EMPConstants.BaseEntities.SOME)
                            {
                                var parentdata = db.emp_CustomerInformation
           .Join(db.emp_CustomerLoginInformation, custinfo => custinfo.Id, custlog => custlog.CustomerOfficeId,
                               (custinfo, custlog) => new { custinfo, custlog })
           .Where(o => o.custinfo.Id == model.ParentId)
           //.GroupBy(x => new {
           //    x.fee.FeesFor,
           //    x.fee.Name
           //})
           .Select(g => new
           {
               Id = g.custinfo.Id,
               CrossLinkUserId = g.custlog.CrossLinkUserId,
           }
         ).FirstOrDefault();


                                if (parentdata != null)
                                {
                                    var NewUser = db.emp_CustomerLoginInformation.Where(o => o.CrossLinkUserId == parentdata.CrossLinkUserId).OrderByDescending(o => o.LastUpdatedDate).Take(1).SingleOrDefault();


                                    var parentdata2 = db.emp_CustomerInformation
         .Join(db.emp_CustomerLoginInformation, custinfo => custinfo.Id, custlog => custlog.CustomerOfficeId,
                             (custinfo, custlog) => new { custinfo, custlog })
         .Where(o => o.custinfo.ParentId == model.ParentId)
         .Select(g => new
         {
             CrossLinkUserId = g.custlog.CrossLinkUserId,
         }
       ).ToList();
                                    string UserIdChar = "A";
                                    if (parentdata2.ToList().Count > 0)
                                    {
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "A")).ToList().Count > 0)
                                        {
                                            UserIdChar = "B";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "B")).ToList().Count > 0)
                                        {
                                            UserIdChar = "C";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "C")).ToList().Count > 0)
                                        {
                                            UserIdChar = "D";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "D")).ToList().Count > 0)
                                        {
                                            UserIdChar = "E";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "E")).ToList().Count > 0)
                                        {
                                            UserIdChar = "F";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "F")).ToList().Count > 0)
                                        {
                                            UserIdChar = "G";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "G")).ToList().Count > 0)
                                        {
                                            UserIdChar = "H";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "H")).ToList().Count > 0)
                                        {
                                            UserIdChar = "I";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "I")).ToList().Count > 0)
                                        {
                                            UserIdChar = "J";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "J")).ToList().Count > 0)
                                        {
                                            UserIdChar = "K";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "K")).ToList().Count > 0)
                                        {
                                            UserIdChar = "L";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "L")).ToList().Count > 0)
                                        {
                                            UserIdChar = "M";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "M")).ToList().Count > 0)
                                        {
                                            UserIdChar = "N";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "N")).ToList().Count > 0)
                                        {
                                            UserIdChar = "O";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "O")).ToList().Count > 0)
                                        {
                                            UserIdChar = "P";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "P")).ToList().Count > 0)
                                        {
                                            UserIdChar = "Q";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "Q")).ToList().Count > 0)
                                        {
                                            UserIdChar = "R";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "R")).ToList().Count > 0)
                                        {
                                            UserIdChar = "S";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "S")).ToList().Count > 0)
                                        {
                                            UserIdChar = "T";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "T")).ToList().Count > 0)
                                        {
                                            UserIdChar = "U";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "U")).ToList().Count > 0)
                                        {
                                            UserIdChar = "V";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "V")).ToList().Count > 0)
                                        {
                                            UserIdChar = "W";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "W")).ToList().Count > 0)
                                        {
                                            UserIdChar = "X";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "X")).ToList().Count > 0)
                                        {
                                            UserIdChar = "Y";
                                        }
                                        if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "Y")).ToList().Count > 0)
                                        {
                                            UserIdChar = "Z";
                                        }
                                    }

                                    emp_CustomerLoginInfo.CrossLinkUserId = parentdata.CrossLinkUserId + UserIdChar;
                                    emp_CustomerLoginInfo.EMPUserId = parentdata.CrossLinkUserId + UserIdChar;

                                    var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                                    var stringChars = new char[8];
                                    var random = new Random();

                                    for (int i = 0; i < stringChars.Length; i++)
                                    {
                                        stringChars[i] = chars[random.Next(chars.Length)];
                                    }

                                    var finalString = new String(stringChars);

                                    string Password = PasswordManager.CryptText(finalString);
                                    emp_CustomerLoginInfo.CrossLinkPassword = Password;
                                    emp_CustomerLoginInfo.EMPPassword = Password;
                                }
                                else
                                {
                                    return -2;
                                }
                            }

                            emp_CustomerLoginInfo.StatusCode = EMPConstants.Active;
                            emp_CustomerLoginInfo.CreatedBy = model.UserId ?? Guid.Empty;
                            emp_CustomerLoginInfo.CreatedDate = DateTime.Now;
                            emp_CustomerLoginInfo.LastUpdatedDate = DateTime.Now;
                            emp_CustomerLoginInfo.LastUpdatedBy = model.UserId ?? Guid.Empty;
                            emp_CustomerLoginInfo.OfficePortalUrl = model.OfficePortalUrl;
                            db.emp_CustomerLoginInformation.Add(emp_CustomerLoginInfo);
                            db.SaveChanges();
                            db.Dispose();
                            return 1;
                        }
                        catch (Exception ex)
                        {
                            return 0;
                        }

                    }
                    else
                    {
                        return -1;
                    }
                }
                return 0;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/SaveCustomerSubSiteInfo", model.UserId);
                return 0;
            }
        }

        public bool SaveCustomerconfigStatus(Guid CustomerId, Guid UserId, string SiteMapID)
        {
            try
            {

                db = new DatabaseEntities();
                Guid SiteMapId;
                if (!Guid.TryParse(SiteMapID, out SiteMapId))
                {
                    return false;
                }

                var Exist = db.CustomerConfigurationStatus.Any(a => a.CustomerId == CustomerId && a.SitemapId == SiteMapId);
                if (Exist == false)
                {
                    CustomerConfigurationStatu ConfigStatusModel = new CustomerConfigurationStatu();
                    ConfigStatusModel.Id = Guid.NewGuid();
                    ConfigStatusModel.CustomerId = CustomerId;
                    ConfigStatusModel.SitemapId = SiteMapId;
                    ConfigStatusModel.StatusCode = "done";
                    ConfigStatusModel.UpdatedBy = UserId;
                    ConfigStatusModel.UpdatedDate = DateTime.Now;
                    db.CustomerConfigurationStatus.Add(ConfigStatusModel);

                    emp_CustomerInformation empCustInfo = new emp_CustomerInformation();
                    empCustInfo = db.emp_CustomerInformation.Where(o => o.Id == CustomerId).FirstOrDefault();
                    if (empCustInfo != null)
                    {
                        empCustInfo.IsActivationCompleted = 1;
                        db.Entry(empCustInfo).State = System.Data.Entity.EntityState.Modified;
                    }

                    db.SaveChanges();
                }

                return true;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/SaveCustomerconfigStatus", UserId);
                return false;
            }
        }

        public List<CustomerAssociatedFeesDTO> CustomerFees(Guid Id)
        {
            try
            {

                List<CustomerAssociatedFeesDTO> CustomerAssociatedFeesDTOList = new List<CustomerAssociatedFeesDTO>();
                var items = db.CustomerAssociatedFees
                  .Join(db.FeeMasters, cfe => cfe.FeeMaster_ID, fee => fee.Id,
                                      (cfe, fee) => new { cfe, fee })
                  .Where(o => o.cfe.emp_CustomerInformation_ID == Id)
                  .GroupBy(x => new
                  {
                      x.fee.FeesFor,
                      x.fee.Name
                  }
                   )
                  .Select(g => new
                  {
                      FeeFor = g.Key.FeesFor,
                      Name = g.Key.Name,
                      Amount = g.Sum(z => z.fee.Amount),
                      Count = g.Count()
                  }
                ).ToList();

                foreach (var value in items)
                {
                    CustomerAssociatedFeesDTO CustFees = new CustomerAssociatedFeesDTO();
                    CustFees.FeesName = "<span>" + value.Name + " : " + value.Amount + "</span>";
                    CustFees.Amount = value.Amount ?? 0;
                    CustFees.FeeFor = value.FeeFor ?? 0;
                    CustFees.FeeForText = (value.FeeFor == (int)EMPConstants.FeesFor.SVBFees) ? EMPConstants.FeesFor.SVBFees.ToString() : EMPConstants.FeesFor.TransmissionFees.ToString();

                    if (CustomerAssociatedFeesDTOList.Where(o => o.FeeFor == value.FeeFor).ToList().Count > 0)
                    {
                        CustFees.Amount = CustomerAssociatedFeesDTOList.Where(o => o.FeeFor == value.FeeFor).FirstOrDefault().Amount + value.Amount ?? 0;
                        CustFees.FeesName = CustomerAssociatedFeesDTOList.Where(o => o.FeeFor == value.FeeFor).FirstOrDefault().FeesName + CustFees.FeesName;
                        CustomerAssociatedFeesDTOList.RemoveAll(o => o.FeeFor == value.FeeFor);
                    }

                    CustomerAssociatedFeesDTOList.Add(CustFees);
                }

                return CustomerAssociatedFeesDTOList;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/CustomerFees", Id);
                return new List<CustomerAssociatedFeesDTO>();
            }
        }

        public List<CustomerAssociatedFeesDTO> BankFee(Guid Id, Guid ParentId, string CompanyName, string ParentCompanyName, int EntityType, bool IsMSO)
        {
            List<CustomerAssociatedFeesDTO> CustomerAssociatedFeesDTOList = new List<CustomerAssociatedFeesDTO>();

            try
            {

                //var EnrollBank = db.BankEnrollments.Where(o => o.CustomerId == ParentId && o.StatusCode == EMPConstants.Ready).ToList();

                //if (EnrollBank != null)
                //{
                var EnrollBankSelection = db.EnrollmentBankSelections.Where(o => o.CustomerId == Id && o.StatusCode != EMPConstants.InActive).ToList();
                List<int> ServerOrTransmissions = new List<int>();

                foreach (var itemn in EnrollBankSelection)
                {
                    CustomerAssociatedFeesDTOList.AddRange(CustomerFees(ParentId));

                    if (itemn.IsTransmissionFee == true)
                    {
                        ServerOrTransmissions.Add(2);
                    }

                    if (itemn.IsServiceBureauFee == true)
                    {
                        ServerOrTransmissions.Add(1);
                    }

                    List<SubSiteFeeConfig> SubSiteFeeConfigd = new List<EMPEntityFramework.Edmx.SubSiteFeeConfig>();

                    if (ServerOrTransmissions.ToList().Count > 0)
                    {
                        SubSiteFeeConfigd = db.SubSiteFeeConfigs.Where(o => o.emp_CustomerInformation_ID == ParentId && ServerOrTransmissions.Contains(o.ServiceorTransmission)).ToList();
                    }
                    else
                    {
                        SubSiteFeeConfigd = db.SubSiteFeeConfigs.Where(o => o.emp_CustomerInformation_ID == ParentId).ToList();
                    }

                    foreach (var item in SubSiteFeeConfigd)
                    {
                        CustomerAssociatedFeesDTO CustomerAssociatedFees = new CustomerAssociatedFeesDTO();

                        List<SubSiteBankFeesConfig> SubSiteBankFeeConfigList = new List<SubSiteBankFeesConfig>();

                        SubSiteBankFeeConfigList = db.SubSiteBankFeesConfigs.Where(o => o.emp_CustomerInformation_ID == ParentId && o.SubSiteFeeConfig_ID == item.ID && o.BankMaster_ID == itemn.BankId).ToList();

                        //foreach (var BankFees in SubSiteBankFeeConfigList)
                        //{
                        //    if (IsMSO)
                        //    {
                        //        CustomerAssociatedFees.Amount = BankFees.BankMaxFees_MSO ?? 0;
                        //    }
                        //    else
                        //    {
                        //        CustomerAssociatedFees.Amount = BankFees.BankMaxFees;
                        //    }
                        //}

                        //if (item.IsSameforAll && CustomerAssociatedFees.Amount == 0)
                        //{
                        //    CustomerAssociatedFees.FeeStatus = "No Add-On";
                        //}
                        //else if (item.IsAddOnFeeCharge == false)
                        //{
                        //    CustomerAssociatedFees.FeeStatus = "No Add-On";
                        //}
                        //else
                        //{
                        //    CustomerAssociatedFees.FeeStatus = CustomerAssociatedFees.Amount.ToString();
                        //}

                        //  CustomerAssociatedFees.FeeFor = item.ServiceorTransmission == 1 ? (int)EMPConstants.FeesFor.SVBFees : (int)EMPConstants.FeesFor.TransmissionFees;
                        //  CustomerAssociatedFees.FeesName = "<span>" + ParentCompanyName + " : " + CustomerAssociatedFees.FeeStatus + "</span>";
                        // CustomerAssociatedFeesDTOList.Add(CustomerAssociatedFees);

                        CustomerAssociatedFees = new CustomerAssociatedFeesDTO();
                        if (EntityType > 0)
                        {
                            if (item.IsAddOnFeeCharge == true)
                            {
                                List<SubSiteBankFeesConfig> SubSiteBankFeesConfigList2 = new List<SubSiteBankFeesConfig>();
                                SubSiteBankFeesConfigList2 = db.SubSiteBankFeesConfigs.Where(o => o.emp_CustomerInformation_ID == Id && o.ServiceOrTransmitter == item.ServiceorTransmission && o.BankMaster_ID == itemn.BankId).ToList();

                                decimal ChildAmount = 0;
                                foreach (var BankFees in SubSiteBankFeesConfigList2)
                                {
                                    if (IsMSO)
                                    {
                                        ChildAmount = BankFees.BankMaxFees_MSO ?? 0;
                                        CustomerAssociatedFees.Amount = BankFees.BankMaxFees_MSO ?? 0;
                                    }
                                    else
                                    {
                                        ChildAmount = BankFees.BankMaxFees;
                                        CustomerAssociatedFees.Amount = BankFees.BankMaxFees;
                                    }
                                }

                                if (item.IsSameforAll)
                                {
                                    CustomerAssociatedFees.FeeStatus = "No Add-On";
                                }
                                else if (item.IsAddOnFeeCharge == false)
                                {
                                    CustomerAssociatedFees.FeeStatus = "Not Allowed";
                                }
                                else
                                {
                                    CustomerAssociatedFees.FeeStatus = ChildAmount.ToString();
                                }

                                CustomerAssociatedFees.FeeFor = item.ServiceorTransmission == 1 ? (int)EMPConstants.FeesFor.SVBFees : (int)EMPConstants.FeesFor.TransmissionFees;
                                CustomerAssociatedFees.FeesName = "<span>" + CompanyName + " : " + CustomerAssociatedFees.FeeStatus + "</span>";
                            }
                            else
                            {
                                CustomerAssociatedFees.FeeStatus = "Not Allowed";
                                CustomerAssociatedFees.FeeFor = item.ServiceorTransmission == 1 ? (int)EMPConstants.FeesFor.SVBFees : (int)EMPConstants.FeesFor.TransmissionFees;
                                CustomerAssociatedFees.FeesName = "<span>" + CompanyName + " : " + CustomerAssociatedFees.FeeStatus + "</span>";
                            }
                            CustomerAssociatedFeesDTOList.Add(CustomerAssociatedFees);

                            //Enrollment Amount


                            CustomerAssociatedFees = new CustomerAssociatedFeesDTO();
                            EnrollmentBankSelection EnrollBankSelectionSubSite = new EnrollmentBankSelection();

                            if (ServerOrTransmissions.ToList().Count > 0)
                            {
                                if (item.ServiceorTransmission == 1)
                                {
                                    CustomerAssociatedFees.Amount = itemn.ServiceBureauBankAmount ?? 0;
                                }
                                else
                                {
                                    CustomerAssociatedFees.Amount = itemn.TransmissionBankAmount ?? 0;
                                }

                                CustomerAssociatedFees.FeeStatus = CustomerAssociatedFees.Amount.ToString();
                                CustomerAssociatedFees.FeeFor = item.ServiceorTransmission == 1 ? (int)EMPConstants.FeesFor.SVBFees : (int)EMPConstants.FeesFor.TransmissionFees;
                                CustomerAssociatedFees.FeesName = "<span>Enrollment Add-On : " + CustomerAssociatedFees.FeeStatus + "</span>";
                                CustomerAssociatedFeesDTOList.Add(CustomerAssociatedFees);
                            }
                        }
                    }
                }

                return CustomerAssociatedFeesDTOList;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/BankFee_Old2", Id);
                return CustomerAssociatedFeesDTOList;
            }
        }

        public bool EmpCsrLogger(Guid UserId)
        {
            try
            {
                using (var db = new DatabaseEntities())
                {
                    string strDescription = "Automated 2016 EMP Enrollment Case";

                    string strOwnerID = db.emp_CustomerInformation.Where(a => a.Id == UserId).Select(a => a.SalesforceAccountID).FirstOrDefault();

                    var Enroll = db.SubSiteConfigurations.Where(a => a.emp_CustomerInformation_ID == UserId && a.IsuTaxManageingEnrolling == true).FirstOrDefault();
                    if (Enroll != null)
                    {
                        strDescription = "Automated 2016 EMP Enrollment Case";
                        Guid iretval = SaveEmpCsrData(UserId, strDescription, strOwnerID);

                        emp_CustomerInformation empCustInfo = new emp_CustomerInformation();
                        empCustInfo = db.emp_CustomerInformation.Where(o => o.Id == UserId).FirstOrDefault();
                        if (empCustInfo != null)
                        {
                            empCustInfo.IsCSRUpdated = true;
                            empCustInfo.CSRUpdatedDt = System.DateTime.Now;
                            empCustInfo.EnrollmentPrimaryKey = iretval;
                            db.Entry(empCustInfo).State = System.Data.Entity.EntityState.Modified;
                        }
                        db.SaveChanges();
                    }
                    var OnBoard = db.SubSiteConfigurations.Where(a => a.emp_CustomerInformation_ID == UserId && a.IsuTaxManageOnboarding == true).FirstOrDefault();
                    if (OnBoard != null)
                    {
                        strDescription = "Automated 2016 Onboarding Case";
                        Guid iretval = SaveEmpCsrData(UserId, strDescription, strOwnerID);

                        emp_CustomerInformation empCustInfo = new emp_CustomerInformation();
                        empCustInfo = db.emp_CustomerInformation.Where(o => o.Id == UserId).FirstOrDefault();
                        if (empCustInfo != null)
                        {
                            empCustInfo.IsCSRUpdated = true;
                            empCustInfo.CSRUpdatedDt = System.DateTime.Now;
                            empCustInfo.OnBoardPrimaryKey = iretval;
                            db.Entry(empCustInfo).State = System.Data.Entity.EntityState.Modified;
                        }
                        db.SaveChanges();
                    }
                }
                return true;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/EmpCsrLogger", UserId);
                return false;
            }
        }

        public Guid SaveEmpCsrData(Guid UserId, string strDescription, string strOwnerID)
        {
            Guid ReturnID;
            try
            {
                using (var DBCSREntity = new EMPDB_CSREntities())
                {
                    tblCase otblCase = new tblCase();
                    //otblCase.AccountSfdcId=
                    otblCase.Id = Guid.NewGuid();
                    ReturnID = otblCase.Id;
                    //otblCase.AssignedAgentId=
                    otblCase.BankEnrollment = false;
                    otblCase.CctSelections = "";
                    //otblCase.ClosedDate=
                    otblCase.CreatedByAgentId = "emp";
                    otblCase.CreatedDate = System.DateTime.Now;
                    otblCase.Description = strDescription;
                    //otblCase.FunctionalArea=
                    otblCase.IsClosed = false;
                    otblCase.IsDeleted = false;
                    //otblCase.Issue=
                    otblCase.LastModifiedByAgentId = "";
                    otblCase.LastModifiedDate = System.DateTime.Now;
                    otblCase.LastViewedDate = System.DateTime.Now;
                    otblCase.LockedByAgentId = "";
                    //otblCase.Module=
                    //otblCase.Origin=
                    otblCase.OwnerId = strOwnerID;
                    otblCase.Priority = "Medium";
                    //otblCase.Product=
                    //otblCase.Reason=
                    //otblCase.SfdcCaseNumber=
                    otblCase.Status = "New";
                    otblCase.Subject = strDescription;
                    otblCase.TaxSeason = "2016";
                    //otblCase.Type=
                    DBCSREntity.tblCases.Add(otblCase);
                    DBCSREntity.SaveChanges();
                    DBCSREntity.Dispose();
                }
                return ReturnID;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/SaveEmpCsrData", UserId);
                return Guid.Empty;
            }
        }

        public IQueryable<CustomerRecenltyModel> GetRecentlyCreatedDetails(Guid UserID)
        {
            try
            {

                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where //cli.CrossLinkUserId != null && 
                            e.StatusCode != EMPConstants.NewCustomer
                            select new { e, cli }).ToList();
                var data2 = data;
                if (data.Count > 0)
                {
                    if (data.Any(a => a.cli.CustomerOfficeId == UserID))
                    {
                        data = data.Where(a => a.cli.CustomerOfficeId == UserID).ToList();
                    }
                }
                if (data.ToList().Count == 1)
                {
                    var data_recCreate = data2.Where(a => a.e.ParentId == data[0].e.Id).OrderByDescending(a => a.cli.CreatedDate).Select(o => new CustomerRecenltyModel
                    {
                        Name = o.e.CompanyName,
                        updateDatetime = o.cli.CreatedDate ?? System.DateTime.Now
                    }).Take(3).DefaultIfEmpty();
                    return data_recCreate.AsQueryable();
                }
                else
                {
                    var data_recCreate = data.OrderByDescending(a => a.cli.CreatedDate).Select(o => new CustomerRecenltyModel
                    {
                        Name = o.e.CompanyName,
                        updateDatetime = o.cli.CreatedDate ?? System.DateTime.Now
                    }).Take(3).DefaultIfEmpty();
                    return data_recCreate.AsQueryable();

                }
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetRecentlyCreatedDetails", UserID);
                return new List<CustomerRecenltyModel>().AsQueryable();
            }
        }

        public IQueryable<CustomerRecenltyModel> GetRecentlyUpdateDetails(Guid UserID)
        {
            try
            {

                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where //cli.CrossLinkUserId != null && 
                            e.StatusCode != EMPConstants.NewCustomer
                            select new { e, cli }).ToList();
                var data2 = data;
                if (data.Count > 0)
                {
                    if (data.Any(a => a.cli.CustomerOfficeId == UserID))
                    {
                        data = data.Where(a => a.cli.CustomerOfficeId == UserID).ToList();
                    }
                }
                if (data.ToList().Count == 1)
                {
                    var data_recCreate = data2.Where(a => a.e.ParentId == data[0].e.Id).OrderByDescending(a => a.e.LastUpdatedDate).Select(o => new CustomerRecenltyModel
                    {
                        Name = o.e.CompanyName,
                        updateDatetime = o.e.LastUpdatedDate ?? System.DateTime.Now
                    }).Take(3).DefaultIfEmpty();
                    return data_recCreate.AsQueryable();
                }
                else
                {
                    var data_recCreate = data.OrderByDescending(a => a.e.LastUpdatedDate).Select(o => new CustomerRecenltyModel
                    {
                        Name = o.e.CompanyName,
                        updateDatetime = o.e.LastUpdatedDate ?? System.DateTime.Now
                    }).Take(3).DefaultIfEmpty();
                    return data_recCreate.AsQueryable();
                }

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetRecentlyUpdateDetails", UserID);
                return new List<CustomerRecenltyModel>().AsQueryable();
            }
        }

        public bool SaveExistingForAdditionalEFINSubSite(Guid MyId, Guid ParentId, Guid UserId)
        {
            try
            {

                db = new DatabaseEntities();

                var SubSiteOfficeConfigs = db.SubSiteOfficeConfigs.Where(o => o.RefId == ParentId).ToList();
                //List<SubSiteOfficeConfig> SubSiteOfficeConfigList = new List<SubSiteOfficeConfig>();
                foreach (var item in SubSiteOfficeConfigs)
                {
                    SubSiteOfficeConfig SubSiteOfficeCon = new SubSiteOfficeConfig();
                    SubSiteOfficeCon.Id = Guid.NewGuid();
                    SubSiteOfficeCon.RefId = MyId;
                    SubSiteOfficeCon.SubSiteSendTaxReturn = item.SubSiteSendTaxReturn;
                    SubSiteOfficeCon.CanSubSiteLoginToEmp = item.CanSubSiteLoginToEmp;
                    SubSiteOfficeCon.EFINListedOtherOffice = item.EFINListedOtherOffice;
                    SubSiteOfficeCon.EFINOwnerSite = item.EFINOwnerSite;
                    SubSiteOfficeCon.IsMainSiteTransmitTaxReturn = item.IsMainSiteTransmitTaxReturn;
                    SubSiteOfficeCon.IsSoftwareOnNetwork = item.IsSoftwareOnNetwork;
                    SubSiteOfficeCon.NoofComputers = item.NoofComputers;
                    SubSiteOfficeCon.NoofTaxProfessionals = item.NoofTaxProfessionals;
                    SubSiteOfficeCon.PreferredLanguage = item.PreferredLanguage;
                    SubSiteOfficeCon.SiteanMSOLocation = item.SiteanMSOLocation;
                    SubSiteOfficeCon.SiteOwnthisEFIN = item.SiteOwnthisEFIN;
                    SubSiteOfficeCon.SOorSSorEFIN = 1;
                    SubSiteOfficeCon.CreatedBy = UserId;
                    SubSiteOfficeCon.CreatedDate = DateTime.Now;
                    SubSiteOfficeCon.LastUpdatedBy = UserId;
                    SubSiteOfficeCon.LastUpdatedDate = DateTime.Now;

                    //SubSiteOfficeConfigList.Add(SubSiteOfficeCon);
                    db.SubSiteOfficeConfigs.Add(SubSiteOfficeCon);
                }


                var SubSiteBankFeesConfig = db.SubSiteBankFeesConfigs.Where(o => o.emp_CustomerInformation_ID == ParentId).ToList();
                foreach (var item in SubSiteBankFeesConfig)
                {
                    SubSiteBankFeesConfig SubSiteBankFeesConfi = new SubSiteBankFeesConfig();
                    SubSiteBankFeesConfi.ID = Guid.NewGuid();
                    SubSiteBankFeesConfi.BankMaster_ID = item.BankMaster_ID;
                    SubSiteBankFeesConfi.BankMaxFees = item.BankMaxFees;
                    SubSiteBankFeesConfi.BankMaxFees_MSO = item.BankMaxFees_MSO;
                    SubSiteBankFeesConfi.emp_CustomerInformation_ID = MyId;
                    SubSiteBankFeesConfi.QuestionID = item.QuestionID;
                    SubSiteBankFeesConfi.ServiceOrTransmitter = item.ServiceOrTransmitter;
                    SubSiteBankFeesConfi.SubSiteFeeConfig_ID = item.SubSiteFeeConfig_ID;

                    SubSiteBankFeesConfi.CreatedBy = UserId;
                    SubSiteBankFeesConfi.CreatedDate = DateTime.Now;
                    SubSiteBankFeesConfi.LastUpdatedBy = UserId;
                    SubSiteBankFeesConfi.LastUpdatedDate = DateTime.Now;
                    db.SubSiteBankFeesConfigs.Add(SubSiteBankFeesConfi);
                }


                List<Guid> SiteMapIdList = new List<Guid>();
                SiteMapIdList.Add(Guid.Parse("7a2c166c-c2ef-47c0-aa5f-e4950f9ff369"));
                SiteMapIdList.Add(Guid.Parse("067c03a3-34f1-4143-beae-35327a8fca44"));
                SiteMapIdList.Add(Guid.Parse("0feeb0fe-d0e7-4370-8733-dd5f7d2041fc"));
                SiteMapIdList.Add(Guid.Parse("98a706d7-031f-4c5d-8cc4-d32cc7658b69"));


                var CustomerConfigurationStatu = db.CustomerConfigurationStatus.Where(o => o.CustomerId == ParentId && !SiteMapIdList.Contains(o.SitemapId ?? Guid.Empty)).ToList();
                foreach (var item in CustomerConfigurationStatu)
                {
                    CustomerConfigurationStatu CustomerConfiguration = new CustomerConfigurationStatu();
                    CustomerConfiguration.Id = Guid.NewGuid();
                    CustomerConfiguration.CustomerId = MyId;
                    CustomerConfiguration.SitemapId = item.SitemapId;
                    CustomerConfiguration.StatusCode = item.StatusCode;
                    CustomerConfiguration.UpdatedBy = UserId;
                    CustomerConfiguration.UpdatedDate = DateTime.Now;
                    db.CustomerConfigurationStatus.Add(CustomerConfiguration);
                }

                //[dbo].[EnrollmentOfficeConfiguration]
                //[dbo].[EnrollmentAffiliateConfiguration]
                var EnrollmentOfficeConfigList = db.EnrollmentOfficeConfigurations.Where(o => o.CustomerId == ParentId).ToList();
                foreach (var item in EnrollmentOfficeConfigList)
                {
                    EnrollmentOfficeConfiguration EnrollmentOfficeConfig = new EnrollmentOfficeConfiguration();
                    EnrollmentOfficeConfig.Id = Guid.NewGuid();
                    EnrollmentOfficeConfig.CustomerId = MyId;
                    EnrollmentOfficeConfig.IsMainSiteTransmitTaxReturn = item.IsMainSiteTransmitTaxReturn;
                    EnrollmentOfficeConfig.IsSoftwareOnNetwork = item.IsSoftwareOnNetwork;
                    EnrollmentOfficeConfig.NoofComputers = item.NoofComputers;
                    EnrollmentOfficeConfig.NoofTaxProfessionals = item.NoofTaxProfessionals;
                    EnrollmentOfficeConfig.PreferredLanguage = item.PreferredLanguage;
                    EnrollmentOfficeConfig.StatusCode = item.StatusCode;
                    EnrollmentOfficeConfig.CreatedBy = ParentId;
                    EnrollmentOfficeConfig.CreatedDate = DateTime.Now;
                    EnrollmentOfficeConfig.LastUpdatedBy = ParentId;
                    EnrollmentOfficeConfig.LastUpdatedDate = DateTime.Now;
                    db.EnrollmentOfficeConfigurations.Add(EnrollmentOfficeConfig);
                }

                var EnrollmentAffiliateConfigList = db.EnrollmentAffiliateConfigurations.Where(o => o.CustomerId == ParentId).ToList();
                foreach (var item in EnrollmentAffiliateConfigList)
                {
                    EnrollmentAffiliateConfiguration EnrollmentAffiliateConfig = new EnrollmentAffiliateConfiguration();
                    EnrollmentAffiliateConfig.Id = Guid.NewGuid();
                    EnrollmentAffiliateConfig.CustomerId = MyId;
                    EnrollmentAffiliateConfig.AffiliateProgramCharge = item.AffiliateProgramCharge;
                    EnrollmentAffiliateConfig.AffiliateProgramId = item.AffiliateProgramId;
                    EnrollmentAffiliateConfig.StatusCode = item.StatusCode;
                    EnrollmentAffiliateConfig.CreatedBy = ParentId;
                    EnrollmentAffiliateConfig.CreatedDate = DateTime.Now;
                    EnrollmentAffiliateConfig.LastUpdatedBy = ParentId;
                    EnrollmentAffiliateConfig.LastUpdatedDate = DateTime.Now;
                    db.EnrollmentAffiliateConfigurations.Add(EnrollmentAffiliateConfig);
                }

                try
                {
                    db.SaveChanges();
                    db.Dispose();
                }
                catch (Exception ex)
                {
                    return false;
                }
                return true;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/SaveExistingForAdditionalEFINSubSite", MyId);
                return false;
            }
        }

        public bool SaveExistingForSubSite(Guid MyId, Guid ParentId)
        {
            try
            {

                db = new DatabaseEntities();

                var SubSiteBankFeesConfig = db.SubSiteBankFeesConfigs.Where(o => o.emp_CustomerInformation_ID == ParentId).ToList();
                foreach (var item in SubSiteBankFeesConfig)
                {
                    SubSiteBankFeesConfig SubSiteBankFeesConfi = new SubSiteBankFeesConfig();
                    SubSiteBankFeesConfi.ID = Guid.NewGuid();
                    SubSiteBankFeesConfi.BankMaster_ID = item.BankMaster_ID;
                    SubSiteBankFeesConfi.BankMaxFees = item.BankMaxFees;
                    SubSiteBankFeesConfi.BankMaxFees_MSO = item.BankMaxFees_MSO;
                    SubSiteBankFeesConfi.emp_CustomerInformation_ID = MyId;
                    // SubSiteBankFeesConfi.QuestionID = item.QuestionID;
                    SubSiteBankFeesConfi.ServiceOrTransmitter = item.ServiceOrTransmitter;
                    //   SubSiteBankFeesConfi.SubSiteFeeConfig_ID = item.SubSiteFeeConfig_ID;

                    SubSiteBankFeesConfi.CreatedBy = ParentId;
                    SubSiteBankFeesConfi.CreatedDate = DateTime.Now;
                    SubSiteBankFeesConfi.LastUpdatedBy = ParentId;
                    SubSiteBankFeesConfi.LastUpdatedDate = DateTime.Now;

                    db.SubSiteBankFeesConfigs.Add(SubSiteBankFeesConfi);
                }

                try
                {
                    db.SaveChanges();
                    db.Dispose();
                }
                catch (Exception ex)
                {
                    return false;
                }

                return true;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/SaveExistingForSubSite", MyId);
                return false;
            }
        }

        public bool SaveUtaxSVBFee(bool uTaxNotCollectingSVBFee, Guid Id)
        {
            try
            {
                db = new DatabaseEntities();
                emp_CustomerInformation customerInformation = db.emp_CustomerInformation.Where(e => e.Id == Id).FirstOrDefault();

                if (customerInformation != null)
                {
                    customerInformation.uTaxNotCollectingSBFee = uTaxNotCollectingSVBFee;
                    db.Entry(customerInformation).State = EntityState.Modified;
                    db.SaveChanges();
                }
                else
                {
                    return false;
                }

                return true;
            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/SaveUtaxSVBFee", Id);
                return false;
            }
        }

        public CustomerInfoNewGrid GetSearchCustomerInformationNewGrid(CustomerInfoNewGrid omodel)
        {
            try
            {

                int CounttotalRecords = 0;

                List<string> Statuslst = !string.IsNullOrEmpty(omodel.Status) ? omodel.Status.Split(',').ToList() : null;
                List<string> SiteTypelst = !string.IsNullOrEmpty(omodel.SiteType) ? omodel.SiteType.Split(',').ToList() : null;
                List<string> BankPartnerlst = !string.IsNullOrEmpty(omodel.BankPartner) ? omodel.BankPartner.Split(',').ToList() : null;
                List<string> EnrollmentStatuslst = !string.IsNullOrEmpty(omodel.EnrollmentStatus) ? omodel.EnrollmentStatus.Split(',').ToList() : null;
                List<string> OnBoardingStatuslst = !string.IsNullOrEmpty(omodel.OnBoardingStatus) ? omodel.OnBoardingStatus.Split(',').ToList() : null;
                List<TestModel1> data = new List<TestModel1>();
                bool iretval = false;

                #region "Search Drop down lists"
                if (Statuslst != null)
                {
                    iretval = true;
                    #region "Status Dropdown list"
                    if (ExistOrNotCustomer(omodel.UserId))
                    {
                        data = (from e in db.emp_CustomerInformation
                                join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                orderby e.CompanyName
                                where e.ParentId == null && cli.CrossLinkUserId != null
                                 && e.StatusCode != EMPConstants.NewCustomer
                                 && Statuslst.Contains(e.StatusCode) && cli.CustomerOfficeId == omodel.UserId
                                select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        CounttotalRecords = (from e in db.emp_CustomerInformation
                                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                             orderby e.CompanyName
                                             where e.ParentId == null && cli.CrossLinkUserId != null
                                              && e.StatusCode != EMPConstants.NewCustomer
                                               && Statuslst.Contains(e.StatusCode) && cli.CustomerOfficeId == omodel.UserId
                                             select new { e, cli }).Count();
                    }
                    else
                    {
                        data = (from e in db.emp_CustomerInformation
                                join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                orderby e.CompanyName
                                where e.ParentId == null && cli.CrossLinkUserId != null
                                 && e.StatusCode != EMPConstants.NewCustomer
                                 && Statuslst.Contains(e.StatusCode)
                                select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        CounttotalRecords = (from e in db.emp_CustomerInformation
                                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                             orderby e.CompanyName
                                             where e.ParentId == null && cli.CrossLinkUserId != null
                                              && e.StatusCode != EMPConstants.NewCustomer
                                               && Statuslst.Contains(e.StatusCode)
                                             select new { e, cli }).Count();
                    }
                    #endregion
                }
                if (SiteTypelst != null)
                {
                    iretval = true;
                    #region "Site type Drop down list"
                    if (ExistOrNotCustomer(omodel.UserId))
                    {
                        data = (from e in db.emp_CustomerInformation
                                join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                orderby e.CompanyName
                                where e.ParentId == null && cli.CrossLinkUserId != null
                                 && e.StatusCode != EMPConstants.NewCustomer
                                 && SiteTypelst.Contains(e.EntityId.ToString()) && cli.CustomerOfficeId == omodel.UserId
                                select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        CounttotalRecords = (from e in db.emp_CustomerInformation
                                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                             orderby e.CompanyName
                                             where e.ParentId == null && cli.CrossLinkUserId != null
                                              && e.StatusCode != EMPConstants.NewCustomer
                                              && SiteTypelst.Contains(e.EntityId.ToString()) && cli.CustomerOfficeId == omodel.UserId
                                             select new { e, cli }).Count();
                    }
                    else
                    {
                        data = (from e in db.emp_CustomerInformation
                                join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                orderby e.CompanyName
                                where e.ParentId == null && cli.CrossLinkUserId != null
                                 && e.StatusCode != EMPConstants.NewCustomer
                                 && SiteTypelst.Contains(e.EntityId.ToString())
                                select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        CounttotalRecords = (from e in db.emp_CustomerInformation
                                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                             orderby e.CompanyName
                                             where e.ParentId == null && cli.CrossLinkUserId != null
                                              && e.StatusCode != EMPConstants.NewCustomer
                                              && SiteTypelst.Contains(e.EntityId.ToString())
                                             select new { e, cli }).Count();
                    }
                    #endregion
                }
                #endregion

                if (omodel.SearchType > 0)
                {
                    List<Guid> lstGuids = GetCustomerInfo_ChildList(Statuslst, SiteTypelst, omodel.SearchText, omodel.SearchType, Guid.Empty);
                    iretval = true;
                    #region "Search Data"
                    if (omodel.SearchType == 1)
                    {
                        #region "Company Name Search"
                        if (ExistOrNotCustomer(omodel.UserId))
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && e.CompanyName.ToString().ToLower().Contains(omodel.SearchText.ToLower()) && cli.CustomerOfficeId == omodel.UserId
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer && cli.CustomerOfficeId == omodel.UserId
                                                  && e.CompanyName.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        else
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && e.CompanyName.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer
                                                  && e.CompanyName.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        #endregion
                    }
                    else if (omodel.SearchType == 2)
                    {
                        #region "User ID Search"
                        if (ExistOrNotCustomer(omodel.UserId))
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && cli.CrossLinkUserId.ToString().ToLower().Contains(omodel.SearchText.ToLower()) && cli.CustomerOfficeId == omodel.UserId
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer && cli.CustomerOfficeId == omodel.UserId
                                                  && cli.CrossLinkUserId.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        else
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && cli.CrossLinkUserId.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer
                                                  && cli.CrossLinkUserId.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        #endregion
                    }
                    else if (omodel.SearchType == 3)
                    {
                        #region "EFIN Search"
                        if (ExistOrNotCustomer(omodel.UserId))
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && cli.EFIN.ToString().ToLower().Contains(omodel.SearchText.ToLower()) && cli.CustomerOfficeId == omodel.UserId
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer
                                                  && cli.EFIN.ToString().ToLower().Contains(omodel.SearchText.ToLower()) && cli.CustomerOfficeId == omodel.UserId
                                                 select new { e, cli }).Count();
                        }
                        else
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && cli.EFIN.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer
                                                  && cli.EFIN.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        #endregion
                    }
                    else if (omodel.SearchType == 4)
                    {
                        #region "Alternative Contact Search"
                        if (ExistOrNotCustomer(omodel.UserId))
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && e.AlternativeContact.ToString().ToLower().Contains(omodel.SearchText.ToLower()) && cli.CustomerOfficeId == omodel.UserId
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer && cli.CustomerOfficeId == omodel.UserId
                                                  && e.AlternativeContact.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        else
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && e.AlternativeContact.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer
                                                  && e.AlternativeContact.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        #endregion
                    }
                    else if (omodel.SearchType == 5)
                    {
                        #region "Alternative Phone Search"
                        if (ExistOrNotCustomer(omodel.UserId))
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && e.AlternatePhone.ToString().ToLower().Contains(omodel.SearchText.ToLower()) && cli.CustomerOfficeId == omodel.UserId
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer && cli.CustomerOfficeId == omodel.UserId
                                                  && e.AlternatePhone.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        else
                        {
                            data = (from e in db.emp_CustomerInformation
                                    join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                    orderby e.CompanyName
                                    where e.ParentId == null && cli.CrossLinkUserId != null
                                     && e.StatusCode != EMPConstants.NewCustomer
                                     && e.AlternatePhone.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                    select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                            CounttotalRecords = (from e in db.emp_CustomerInformation
                                                 join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                                 orderby e.CompanyName
                                                 where e.ParentId == null && cli.CrossLinkUserId != null
                                                  && e.StatusCode != EMPConstants.NewCustomer
                                                  && e.AlternatePhone.ToString().ToLower().Contains(omodel.SearchText.ToLower())
                                                 select new { e, cli }).Count();
                        }
                        #endregion
                    }
                    #endregion

                    if (lstGuids.Count() > 0)
                    {
                        iretval = true;
                        var data1 = (from e in db.emp_CustomerInformation
                                     join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                     orderby e.CompanyName
                                     where e.ParentId == null && lstGuids.Contains(e.Id) && cli.CrossLinkUserId != null
                                      && e.StatusCode != EMPConstants.NewCustomer
                                     select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        data.AddRange(data1);

                        data = data.DistinctBy(x => x.e.Id).ToList();
                        CounttotalRecords = data.ToList().Count();
                    }
                }
                if (iretval == false)
                {
                    iretval = ExistOrNotCustomer(omodel.UserId);
                    if (iretval)
                    {
                        data = (from e in db.emp_CustomerInformation
                                join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                orderby e.CompanyName
                                where e.ParentId == null && cli.CrossLinkUserId != null
                                 && e.StatusCode != EMPConstants.NewCustomer && cli.CustomerOfficeId == omodel.UserId
                                select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        CounttotalRecords = (from e in db.emp_CustomerInformation
                                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                             where e.ParentId == null && cli.CrossLinkUserId != null && e.StatusCode != EMPConstants.NewCustomer
                                             && cli.CustomerOfficeId == omodel.UserId
                                             select e).Count();
                    }
                    else
                    {
                        data = (from e in db.emp_CustomerInformation
                                join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                orderby e.CompanyName
                                where e.ParentId == null && cli.CrossLinkUserId != null
                                 && e.StatusCode != EMPConstants.NewCustomer
                                select new TestModel1 { e = e, cli = cli }).ToList().Skip(omodel.start).Take(omodel.length).ToList();

                        CounttotalRecords = (from e in db.emp_CustomerInformation
                                             join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                                             where e.ParentId == null && cli.CrossLinkUserId != null && e.StatusCode != EMPConstants.NewCustomer
                                             select e).Count();
                    }
                }
                List<CustomerModel> customerlst = new List<CustomerModel>();
                foreach (var itm in data)
                {
                    CustomerModel ocustomer = new CustomerModel();
                    ocustomer.Id = itm.e.Id;
                    ocustomer.ParentId = itm.e.ParentId ?? Guid.Empty;
                    ocustomer.str_ParentId = itm.e.ParentId.ToString() ?? "";
                    ocustomer.CompanyName = itm.e.CompanyName;
                    ocustomer.AccountStatus = itm.e.AccountStatus;
                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    ocustomer.MasterIdentifier = itm.e.MasterIdentifier;
                    ocustomer.Feeder = itm.e.Feeder;
                    ocustomer.BusinessOwnerFirstName = itm.e.BusinessOwnerFirstName;
                    ocustomer.OfficePhone = itm.e.OfficePhone;
                    ocustomer.AlternatePhone = itm.e.AlternatePhone;
                    ocustomer.Primaryemail = itm.e.PrimaryEmail;
                    ocustomer.SupportNotificationemail = itm.e.SupportNotificationEmail;
                    ocustomer.EROType = itm.e.EROType;
                    ocustomer.AlternativeContact = itm.e.AlternativeContact ?? "";
                    ocustomer.EFIN = itm.e.EFIN;
                    ocustomer.PhysicalAddress1 = itm.e.PhysicalAddress1;
                    ocustomer.PhysicalAddress2 = itm.e.PhysicalAddress2;
                    ocustomer.PhysicalZipcode = itm.e.PhysicalZipCode;
                    ocustomer.PhysicalCity = itm.e.PhysicalCity;
                    ocustomer.PhysicalState = itm.e.PhysicalState;
                    ocustomer.ShippingAddress1 = itm.e.ShippingAddress1;
                    ocustomer.ShippingAddress2 = itm.e.ShippingAddress2;
                    ocustomer.ShippingZipcode = itm.e.ShippingZipCode;
                    ocustomer.ShippingCity = itm.e.ShippingCity;
                    ocustomer.ShippingState = itm.e.ShippingState;
                    ocustomer.PhoneTypeId = itm.e.PhoneTypeId;
                    ocustomer.TitleId = itm.e.TitleId;
                    ocustomer.AlternativeType = itm.e.AlternativeType;
                    ocustomer.PhoneType = db.PhoneTypeMasters.Where(a => a.Id == itm.e.PhoneTypeId).Select(a => a.PhoneType).FirstOrDefault();
                    ocustomer.ContactTitle = db.ContactPersonTitleMasters.Where(a => a.Id == itm.e.TitleId).Select(a => a.ContactPersonTitle).FirstOrDefault() ?? "";
                    ocustomer.EntityId = itm.e.EntityId ?? 0;
                    ocustomer.SalesYearID = itm.e.SalesYearID ?? Guid.Empty;
                    ocustomer.BaseEntityId = db.EntityMasters.Where(a => a.Id == itm.e.EntityId).Select(a => a.BaseEntityId).FirstOrDefault();
                    ocustomer.LoginId = itm.cli.Id.ToString();
                    ocustomer.LoginEFIN = itm.cli.EFIN;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.CrossLinkUserId = itm.cli.CrossLinkUserId ?? "";
                    ocustomer.CrossLinkPassword = itm.cli.CrossLinkPassword;
                    ocustomer.OfficePortalUrl = itm.cli.OfficePortalUrl;
                    ocustomer.TaxOfficeUsername = itm.cli.TaxOfficeUsername;
                    ocustomer.TaxOfficePassword = itm.cli.TaxOfficePassword;
                    ocustomer.CustomerOfficeId = itm.cli.CustomerOfficeId;
                    ocustomer.MasterIdentifier = itm.cli.MasterIdentifier;
                    ocustomer.IsActivationCompleted = itm.e.IsActivationCompleted ?? 0;
                    var taxreturn = db.MainOfficeConfigurations.Where(x => x.emp_CustomerInformation_ID == itm.e.Id).Select(x => x).FirstOrDefault();
                    ocustomer.IsTaxReturn = taxreturn == null ? true : taxreturn.IsSiteTransmitTaxReturns;

                    ocustomer.SalesforceParentID = itm.e.SalesforceParentID;
                    if (itm.e.IsActivationCompleted == null || itm.e.IsActivationCompleted == 0)
                        ocustomer.ActivationStatus = "Not Active";
                    else
                        ocustomer.ActivationStatus = "Active";

                    ocustomer.CreatedDate = itm.cli.CreatedDate ?? Convert.ToDateTime("01/01/2000");
                    ocustomer.LastUpdatedDate = itm.e.LastUpdatedDate ?? Convert.ToDateTime("01/01/2000");

                    ocustomer.IsEnrolled = itm.e.IsEnrolled ?? false;
                    ocustomer.EnrolledBankId = itm.e.EnrolledBankId;

                    EnrollmentBankSelectionService serv = new EnrollmentBankSelectionInfo.EnrollmentBankSelectionService();
                    var enrdata = serv.getEnrollmentStatusInfo(ocustomer.Id);
                    ocustomer.ActiveBank = enrdata.BankName;
                    ocustomer.SubmissionDate = enrdata.SubmitedDate;
                    ocustomer.EnrollmentStatus = enrdata.SubmissionStaus;
                    ocustomer.ApprovedBank = enrdata.ApprovedBank;
                    ocustomer.RejectedBanks = enrdata.RejectedBanks;
                    ocustomer.UnlockedBanks = enrdata.UnlockedBanks;

                    if (ocustomer.EROType == "Single Office" && (itm.e.IsActivationCompleted != 0 && itm.e.IsActivationCompleted != null))
                        ocustomer.IsActivated = true;
                    else
                    {
                        ocustomer.IsActivated = itm.e.IsActivationCompleted.HasValue ? (itm.e.IsActivationCompleted.Value == 1 ? true : false) : false;
                    }


                    #region "Actions"
                    var actions = (from s in db.EMP_ActionMaser
                                   where s.EntityId == itm.e.EntityId && s.Status == EMPConstants.Active
                                   orderby s.DisplayOrder
                                   select new Actions
                                   {
                                       IsParent = s.ParentId,
                                       Name = s.Name,
                                       Display = s.ForActive
                                   }).ToList();

                    ocustomer.Actions = actions;
                    #endregion


                    //var ChildDataLst = GetChildCustomerInfo(itm.e.Id, "", Statuslst, SiteTypelst, omodel.SearchText, omodel.SearchType, Guid.Empty);
                    var ChildDataLst = GetChildCustomerInfo(itm.e.Id, "", null, null, "", 0, omodel.UserId);
                    ocustomer.ChaildCustomerInfo = ChildDataLst;
                    if (ocustomer.ChaildCustomerInfo.Count > 0)
                        ocustomer.ChildInfo = "<a id='" + itm.e.Id + "' onClick=\"fnChildInfo(this)\"><i class='fa fa-plus'></i></a>";
                    else
                        ocustomer.ChildInfo = "";
                    customerlst.Add(ocustomer);
                }
                omodel.recordsTotal = CounttotalRecords;
                omodel.Customerlst = customerlst.OrderBy(a => a.CompanyName).ToList();
                return omodel;

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetSearchCustomerInformationNewGrid", omodel.UserId);
                return omodel;
            }
        }

        public bool ExistOrNotCustomer(Guid CustomerId)
        {
            try
            {

                db = new DatabaseEntities();
                return db.emp_CustomerLoginInformation.Any(a => a.CustomerOfficeId == CustomerId);

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/ExistOrNotCustomer", CustomerId);
                return false;
            }
        }

        public List<Guid> GetCustomerInfo_ChildList(List<string> Statuslst, List<string> SiteTypelst, string SearchText, int SearchType, Guid UserName)
        {
            try
            {

                var data = (from e in db.emp_CustomerInformation
                            join cli in db.emp_CustomerLoginInformation on e.Id equals cli.CustomerOfficeId
                            where e.ParentId != null && cli.CrossLinkUserId != null &&
                            e.StatusCode != EMPConstants.NewCustomer
                            select new { e, cli }).ToList();

                if (Statuslst != null)
                {
                    data = data.Where(o => Statuslst.Contains(o.e.StatusCode)).ToList();
                }
                if (SiteTypelst != null)
                {
                    data = data.Where(o => SiteTypelst.Contains(o.e.EntityId.ToString())).ToList();
                }

                if (SearchType > 0)
                {
                    if (SearchType == 1)
                    {
                        data = data.Where(o => o.e.CompanyName.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                    }
                    else if (SearchType == 2)
                    {
                        data = data.Where(o => o.cli.CrossLinkUserId.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                    }
                    else if (SearchType == 3)
                    {
                        data = data.Where(o => o.e.EFIN.ToString().ToLower().Contains(SearchText.ToLower())).ToList();
                    }
                    else if (SearchType == 4)
                    {
                        data = data.Where(o => o.e.AlternativeContact != null ? o.e.AlternativeContact.ToString().ToLower().Contains(SearchText.ToLower()) : o.e.AlternativeContact == o.e.AlternativeContact).ToList();
                    }
                    else if (SearchType == 5)
                    {
                        data = data.Where(o => o.e.AlternatePhone != null ? o.e.AlternatePhone.ToString().ToLower().Contains(SearchText.ToLower()) : o.e.AlternatePhone == o.e.AlternatePhone).ToList();
                    }
                }
                return data.Select(a => a.e.ParentId ?? Guid.Empty).ToList();

            }
            catch (Exception ex)
            {
                ExceptionLogger.LogException(ex.ToString(), "CustomerInformation/GetCustomerInfo_ChildList", UserName);
                return new List<Guid>();
            }
        }

        public CreateNewUserResponse CreateNewUser(CreateNewUserModel model)
        {
            CreateNewUserResponse res = new CreateNewUserResponse();
            try
            {
                if (model.ParentCustomerId.HasValue && model.ParentCustomerId.Value != Guid.Empty)
                {
                    var logininfo = db.emp_CustomerLoginInformation.Where(x => x.CustomerOfficeId == model.ParentCustomerId).FirstOrDefault();
                    if (logininfo != null)
                    {
                        model.MasterIdentifier = logininfo.MasterIdentifier;
                        res = CreateNewUserApi(model, PasswordManager.DecryptText(logininfo.CrossLinkPassword), res);
                        if (res.Status)
                        {
                            var customerlogininfo = db.emp_CustomerLoginInformation.Where(x => x.CustomerOfficeId == model.CustomerId).FirstOrDefault();
                            if (customerlogininfo != null)
                            {
                                customerlogininfo.CrossLinkUserId = res.UserId;
                                customerlogininfo.CrossLinkPassword = PasswordManager.CryptText(res.Password);
                                customerlogininfo.EMPPassword = PasswordManager.CryptText(res.Password);
                                customerlogininfo.EMPUserId = res.UserId;
                                customerlogininfo.StatusCode = EMPConstants.Active;

                                var officeinfo = db.emp_CustomerInformation.Where(x => x.Id == model.CustomerId).FirstOrDefault();
                                if (officeinfo != null)
                                    officeinfo.StatusCode = EMPConstants.Created;

                                db.SaveChanges();
                            }
                        }
                    }
                    else
                        res.Status = false;
                }
                else
                {
                    res = CreateNewUserApiService(model);
                }
            }
            catch (Exception ex)
            {
                EMPPortal.Core.Utilities.ExceptionLogger.LogException(ex.ToString(), "CustomerInformationService/CreateNewUser", model.CustomerId);
                res.Status = false;
            }
            return res;
        }

        public CreateNewUserResponse CreateNewUserApiService(CreateNewUserModel model)
        {
            CreateNewUserResponse res = new CreateNewUserResponse();
            try
            {
                var masterId = db.UtaxCrosslinkDetails.Where(x => x.Username == model.MasterIdentifier && x.StatusCode == EMPConstants.Active).FirstOrDefault();
                if (masterId != null)
                {
                    res = CreateNewUserApi(model, PasswordManager.Decrypt(masterId.Password), res);
                    if (res.Status)
                    {
                        var logininfo = db.emp_CustomerLoginInformation.Where(x => x.CustomerOfficeId == model.CustomerId).FirstOrDefault();
                        if (logininfo != null)
                        {
                            logininfo.CrossLinkUserId = res.UserId;
                            logininfo.CrossLinkPassword = PasswordManager.DecryptText(res.Password);
                            logininfo.EMPPassword = PasswordManager.DecryptText(res.Password);
                            logininfo.EMPUserId = res.UserId;
                            logininfo.StatusCode = EMPConstants.Active;

                            var officeinfo = db.emp_CustomerInformation.Where(x => x.Id == model.CustomerId).FirstOrDefault();
                            if (officeinfo != null)
                                officeinfo.StatusCode = EMPConstants.Created;

                            db.SaveChanges();
                        }
                    }
                }
                else
                    res.Status = false;
            }
            catch (Exception ex)
            {
                EMPPortal.Core.Utilities.ExceptionLogger.LogException(ex.ToString(), "CustomerInformationService/CreateNewUserApiService", model.CustomerId);
                res.Status = false;
            }
            return res;
        }

        public CreateNewUserResponse CreateNewUserApi(CreateNewUserModel model, string Password, CreateNewUserResponse res)
        {
            try
            {
                string _accesskey = _apiObj.getAccessKey(model.MasterIdentifier, Password);
                if (_accesskey != "")
                {
                    AuthObject _objAuth = new AuthObject();
                    _objAuth.AccessKey = _accesskey;
                    _objAuth.UserID = model.MasterIdentifier;
                    XlinkResponse isValid = _apiObj.isAuth(_objAuth);
                    if (isValid.success)
                    {
                        NewUserObject _objUser = new NewUserObject();
                        _objUser.Account = model.MasterIdentifier;
                        _objUser.AddBusinessProduct = model.AddBusinessProduct;
                        _objUser.CompanyName = model.CompanyName;
                        _objUser.Email = model.Email;
                        _objUser.Fname = model.Fname;
                        _objUser.Lname = model.Lname;
                        _objUser.Phone = model.Phone;
                        _objUser.ShippingAddress = model.ShippingAddress;
                        _objUser.ShippingCity = model.ShippingCity;
                        _objUser.ShippingState = model.ShippingState;
                        _objUser.ShippingState = model.ShippingState;
                        _objUser.ShippingZip = model.ShippingZip;
                        var result = _apiObj.CreateNewUser(_objAuth, _objUser);

                        if (result.success)
                        {
                            var userIds = _apiObj.getUserIDList(_objAuth, model.MasterIdentifier, 0);
                            int newid = Convert.ToInt32(result.message[1].Split(' ')[1].Trim());
                            var newuser = userIds.Where(x => x.UserID == newid).FirstOrDefault();
                            if (newuser != null)
                            {
                                res.MasterIdentifier = newuser.Account;
                                res.Message = result.message.ToList();
                                res.Password = newuser.TransmitPassword;
                                res.Status = result.success;
                                res.UserId = newuser.UserID.ToString();
                            }
                            else
                                res.Status = false;
                        }
                        else
                            res.Status = false;
                    }
                    res.Status = false;
                }
                else
                    res.Status = false;
            }
            catch (Exception ex)
            {
                EMPPortal.Core.Utilities.ExceptionLogger.LogException(ex.ToString(), "CustomerInformationService/CreateNewUserApi", model.CustomerId);
                res.Status = false;
            }
            return res;
        }

        public bool SendEmailForNewUser(NewUserEmailRequest model)
        {
            try
            {
                var customer = db.emp_CustomerInformation.Where(x => x.Id == model.CustomerId).FirstOrDefault();
                if (customer != null)
                {
                    var logininfo = db.emp_CustomerLoginInformation.Where(x => x.CustomerOfficeId == model.CustomerId).FirstOrDefault();
                    EmailNotification email = new EmailNotification();
                    email.CreatedBy = model.UserId;
                    email.CreatedDate = DateTime.Now;
                    email.EmailCC = "";
                    email.EmailContent = "";
                    email.EmailSubject = EMPConstants.NewUserMailSubject;
                    email.EmailTo = customer.PrimaryEmail;
                    email.EmailType = (int)EMPConstants.EmailTypes.NewUser;
                    email.IsSent = false;
                    email.Parameters = "$|$" + logininfo.EMPUserId + "$|$" + PasswordManager.DecryptText(logininfo.EMPPassword) + "$|$" + logininfo.CrossLinkUserId + "$|$" + PasswordManager.DecryptText(logininfo.CrossLinkPassword);
                    db.EmailNotifications.Add(email);
                    db.SaveChanges();
                    return true;
                }
                else
                    return false;
            }
            catch (Exception ex)
            {
                EMPPortal.Core.Utilities.ExceptionLogger.LogException(ex.ToString(), "CustomerInformationService/SendEmailForNewUser", model.UserId);
                return false;
            }
        }

        public EMPCustomerLogin GetEMPCustomerLogin(Guid ParentId)
        {
            EMPCustomerLogin EMPCustomerLogInfo = new EMPCustomerLogin();
            var parentdata = db.emp_CustomerInformation
          .Join(db.emp_CustomerLoginInformation, custinfo => custinfo.Id, custlog => custlog.CustomerOfficeId,
                              (custinfo, custlog) => new
                              {
                                  custinfo,
                                  custlog
                              })
          .Where(o => o.custinfo.Id == ParentId)
          .Select(g => new
          {
              Id = g.custinfo.Id,
              CrossLinkUserId = g.custlog.CrossLinkUserId,
              IsMsoUser = g.custinfo.IsMSOUser ?? false,
              ParentId = g.custinfo.ParentId ?? Guid.Empty
          }).FirstOrDefault();

            if (parentdata != null)
            {
                Guid NewParentId = Guid.Empty;
                NewParentId = ParentId;

                var parentdata2 = db.emp_CustomerInformation
                     .Join(db.emp_CustomerLoginInformation, custinfo => custinfo.Id, custlog => custlog.CustomerOfficeId,
                                         (custinfo, custlog) => new { custinfo, custlog })
                     .Where(o => o.custinfo.ParentId == NewParentId && o.custlog.CrossLinkUserId != null)
                     .Select(g => new
                     {
                         CrossLinkUserId = g.custlog.CrossLinkUserId,
                     }).ToList();

                string UserIdChar = "A";
                if (parentdata2.ToList().Count > 0)
                {
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "A")).ToList().Count > 0)
                    {
                        UserIdChar = "B";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "B")).ToList().Count > 0)
                    {
                        UserIdChar = "C";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "C")).ToList().Count > 0)
                    {
                        UserIdChar = "D";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "D")).ToList().Count > 0)
                    {
                        UserIdChar = "E";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "E")).ToList().Count > 0)
                    {
                        UserIdChar = "F";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "F")).ToList().Count > 0)
                    {
                        UserIdChar = "G";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "G")).ToList().Count > 0)
                    {
                        UserIdChar = "H";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "H")).ToList().Count > 0)
                    {
                        UserIdChar = "I";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "I")).ToList().Count > 0)
                    {
                        UserIdChar = "J";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "J")).ToList().Count > 0)
                    {
                        UserIdChar = "K";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "K")).ToList().Count > 0)
                    {
                        UserIdChar = "L";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "L")).ToList().Count > 0)
                    {
                        UserIdChar = "M";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "M")).ToList().Count > 0)
                    {
                        UserIdChar = "N";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "N")).ToList().Count > 0)
                    {
                        UserIdChar = "O";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "O")).ToList().Count > 0)
                    {
                        UserIdChar = "P";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "P")).ToList().Count > 0)
                    {
                        UserIdChar = "Q";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "Q")).ToList().Count > 0)
                    {
                        UserIdChar = "R";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "R")).ToList().Count > 0)
                    {
                        UserIdChar = "S";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "S")).ToList().Count > 0)
                    {
                        UserIdChar = "T";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "T")).ToList().Count > 0)
                    {
                        UserIdChar = "U";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "U")).ToList().Count > 0)
                    {
                        UserIdChar = "V";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "V")).ToList().Count > 0)
                    {
                        UserIdChar = "W";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "W")).ToList().Count > 0)
                    {
                        UserIdChar = "X";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "X")).ToList().Count > 0)
                    {
                        UserIdChar = "Y";
                    }
                    if (parentdata2.Where(o => o.CrossLinkUserId.Contains(parentdata.CrossLinkUserId + "Y")).ToList().Count > 0)
                    {
                        UserIdChar = "Z";
                    }
                }

                EMPCustomerLogInfo.EMPUserId = parentdata.CrossLinkUserId + UserIdChar;
                EMPCustomerLogInfo.EMPPassword = parentdata.CrossLinkUserId + UserIdChar;

                var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                var stringChars = new char[8];
                var random = new Random();

                for (int i = 0; i < stringChars.Length; i++)
                {
                    stringChars[i] = chars[random.Next(chars.Length)];
                }

                var finalString = new String(stringChars);
                string Password = PasswordManager.CryptText(finalString);
                EMPCustomerLogInfo.EMPPassword = Password;
            }
            return EMPCustomerLogInfo;
        }

        public class EMPCustomerLogin
        {
            public string EMPUserId { get; set; }
            public string EMPPassword { get; set; }

        }


        public class CustModel
        {
            public List<TestModel1> data { get; set; }
        }

        public class TestModel1
        {
            public emp_CustomerInformation e { get; set; }
            public emp_CustomerLoginInformation cli { get; set; }
        }
    }
}